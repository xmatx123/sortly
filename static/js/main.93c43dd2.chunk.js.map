{"version":3,"sources":["assets/logo.png","assets/population.jpg","assets/area.jpg","assets/gini.jpg","firebase.js","contexts/AuthContext.js","services/avatarService.js","services/userProfileService.js","components/LoginButton.js","components/Header.js","components/Footer.js","components/SEO.js","pages/HomePage.js","api/countriesApi.js","components/CountryCard.js","components/Game/DragComponents.js","utils/stringUtils.js","components/Game/ClassicMode.js","services/cooperationGameService.js","components/Game/CooperationMode.js","services/battleRoyaleGameService.js","components/Game/BattleRoyaleMode.js","pages/GamePage.js","api/leaderboardApi.js","services/leaderboardService.js","services/achievementsService.js","services/gameHistoryService.js","pages/GameOverPage.js","utils/dateUtils.js","pages/LeaderboardPage.js","components/profile/AvatarSelector.jsx","components/profile/ProfileHeader.jsx","components/profile/AchievementCard.jsx","components/profile/AchievementsSection.jsx","utils/achievementUtils.js","components/profile/GameHistoryItem.jsx","components/profile/GameHistory.jsx","pages/ProfilePage.js","services/lobbyService.js","components/GameLobby.js","components/FirebaseTest.js","pages/GameReviewPage.js","App.js","index.js"],"names":["module","exports","app","initializeApp","apiKey","process","authDomain","projectId","storageBucket","messagingSenderId","appId","databaseURL","auth","getAuth","db","getFirestore","realtimeDb","getDatabase","AuthContext","createContext","useAuth","useContext","AuthProvider","_ref","children","currentUser","setCurrentUser","useState","loading","setLoading","useEffect","onAuthStateChanged","user","value","signup","email","password","createUserWithEmailAndPassword","login","signInWithEmailAndPassword","logout","signOut","React","createElement","Provider","avatarService","getAvatarOptions","id","url","name","userProfileService","userId","userDoc","getDoc","doc","exists","data","defaultProfile","nickname","country","avatarUrl","createdAt","Date","this","updateUserProfile","error","console","profileData","userRef","setDoc","updatedAt","merge","field","updateDoc","LoginButton","setEmail","setPassword","setError","showLoginForm","setShowLoginForm","userProfile","setUserProfile","navigate","useNavigate","async","profile","getUserProfile","uid","loadUserProfile","className","onClick","src","alt","message","disabled","type","onChange","e","target","placeholder","required","preventDefault","style","color","Header","isMenuOpen","setIsMenuOpen","closeMenu","modes","label","Link","to","logo","toggleMenu","map","category","key","s","toUpperCase","slice","mode","path","state","arguments","length","undefined","handleNav","Footer","getFullYear","SEO","title","description","keywords","image","schema","siteTitle","metaDescription","metaKeywords","metaImage","window","location","origin","metaUrl","href","metaType","Helmet","content","property","JSON","stringify","capitalize","HomePage","categories","populationImage","areaImage","giniImage","cat","backgroundImage","backgroundPosition","backgroundSize","backgroundRepeat","handlePlay","modeLabel","categoryLabel","log","ReactGA","event","action","getLatestGini","giniObj","Object","keys","giniValue","sort","pop","fetchCountries","apiUrl","response","fetch","ok","Error","status","json","Array","isArray","countries","filter","_country$name","_country$flags","latestGini","gini","unMember","common","flags","svg","population","area","index","flagUrl","warn","CountryCard","statisticValue","isFlippable","isClickable","highlight","customClassName","isFlipped","setIsFlipped","highlightClass","handleClick","getDetailText","num","toFixed","toLocaleString","ItemTypes","DraggableCard","isDragging","drag","useDrag","item","collect","monitor","ref","opacity","cursor","width","maxWidth","display","justifyContent","alignItems","DropZone","_ref2","onDrop","isEmpty","isOver","canDrop","drop","useDrop","accept","charAt","ClassicMode","countriesToPick","setCountriesToPick","sortedCountries","setSortedCountries","currentCountry","setCurrentCountry","score","setScore","gameStatus","setGameStatus","isLoading","setIsLoading","validCountries","c","shuffled","Math","random","sortedInitialPair","a","b","_a$category","_b$category","initialSortedCountry","firstCountryToPlace","err","loadGame","pickNextCountry","useCallback","nextCountry","gameMode","replace","handlePlaceCountry","countryToPlace","newSortedCountries","splice","isCorrect","_newSortedCountries$c","_countryToPlace$categ","_countryToPlace$categ2","_newSortedCountries$c2","finalSortedList","incorrectCountry","attemptedIndex","userOrder","reload","idx","Fragment","margin","cooperationGameService","lobbyId","players","allCountries","fetchError","selectedCountries","getRandomElements","arr","initialCountry","inventoryCountries","gameStateRef","initialState","currentPlayer","remainingCountries","now","lastUpdated","set","subscribeToGameState","callback","listener","onValue","snapshot","val","off","updates","update","playerId","chosenCountry","gameState","get","some","placementIndex","potentialNewSortedCountries","countriesList","i","_gameState$players$","placedCountryId","updatedRemainingCountries","nextPlayerId","currentPlayerIndex","findIndex","p","result","endGame","CooperationMode","_gameStateData$player","_gameStateData$player2","categoryProp","setRemainingCountries","setGameState","gameStateData","setGameStateData","unsubscribe","currentCategory","finalScore","messageCategory","handlePlaceCard","placeCard","isMyTurn","currentPlayerName","find","canPlace","aria-label","isSelectedForPlacing","chooseCard","handleChooseCard","battleRoyaleGameService","initialPlayers","isActive","gameType","activePlayers","choosingPlayer","_findNextActivePlayer","currentPlayerId","placingPlayer","playerIndex","activePlayerIds","winner","winnerId","BattleRoyaleMode","_gameStateData$player3","winnerName","winnerScore","finalPlayersState","me","myPlayerState","amIActive","canChoose","VALID_CATEGORIES","VALID_MODES","UnifiedGamePage","_location$state","useParams","useLocation","isValidCategory","includes","toLowerCase","isValidMode","Navigate","DndProvider","backend","HTML5Backend","renderGameMode","getLeaderboard","leaderboardKey","storedData","localStorage","getItem","parse","getTopScores","limit","leaderboard","leaderboardService","playerName","gameHistoryId","entryData","timestamp","serverTimestamp","docRef","addDoc","collection","limitCount","q","query","where","orderBy","getDocs","docs","ACHIEVEMENT_DEFINITIONS","sorting","bronze","icon","requirement","silver","gold","platinum","gameCount","achievementsService","achievements","correctCount","_currentAchievements$","_currentAchievements$2","currentAchievements","getUserAchievements","categoryAchievements","updated","values","forEach","achievement","unlocked","unlockedAt","gameCountAchievement","currentCount","count","updateUserAchievements","getAchievementDefinitions","CATEGORIES","gameHistoryService","gamesRef","firestoreLimit","games","qFallback","querySnapshotFallback","sortedGames","fallbackError","topGames","Promise","all","getTopGames","gameId","docSnap","userAttemptList","correctlySortedList","minimalUserAttempt","rest","minimalCorrectlySorted","minimalIncorrectCountry","docData","GameOverPage","gameModeString","modeString","parts","split","parseGameMode","setPlayerName","isSubmitted","setIsSubmitted","savedGameId","setSavedGameId","hasAttemptedSave","useRef","fetchUserProfile","current","historyScore","historyDataPayload","correctlySortedForSave","incorrectCountryForSave","saveGame","checkAndUpdateAchievements","achievementErr","saveGameHistoryAndCheckAchievements","player","onSubmit","trim","submitScoreValue","submitScore","htmlFor","maxLength","textAlign","formatDate","dateInput","dateObject","toDate","isNaN","getTime","toLocaleDateString","year","month","day","CLASSIC_CATEGORIES","LeaderboardPage","leaderboards","setLeaderboards","fetchedLeaderboards","topScores","enrichedScores","details","getGameDetails","loadLeaderboardsAndDetails","renderLeaderboardTable","entry","_entry$details$correc","alert","date","role","marginTop","AvatarSelector","avatarOptions","selectedAvatar","onSelect","onClose","avatar","ProfileHeader","formData","setFormData","showAvatarSelector","setShowAvatarSelector","isEditing","setIsEditing","handleChange","prev","AchievementCard","isUnlocked","unlockDate","AchievementsSection","achievementDefinitions","transformedAchievements","definitions","entries","categoryData","level","push","transformAchievementDefinitions","_achievements$achieve","_achievements$achieve2","_achievements$achieve3","GameHistoryItem","_game$timestamp","_game$countries","game","GameHistory","gameHistory","useMemo","flatMap","self","g","handleGameClick","ProfilePage","setProfile","setAchievements","setGameHistory","editing","setEditing","loadProfile","userAchievements","userGameHistory","getAllTopGames","onEdit","onAvatarSelect","onAvatarSelectorToggle","onCancel","lobbyService","constructor","lobbiesRef","lobbyRef","lobbyData","currentPlayers","updatedPlayers","remove","subscribeToLobby","startedAt","endedAt","gameSettings","cooperation","minPlayers","maxPlayers","service","battleRoyale","GameLobby","setLobbyId","setPlayers","isHost","setIsHost","copyStatus","setCopyStatus","searchParams","useSearchParams","currentLobbyId","unsubscribeFn","isMounted","fetchProfileError","lobbyParam","targetLobbyId","playerInfo","floor","joinLobby","joinError","toString","substring","createLobby","createError","_lobbyData$players$","dbCategory","navigatePath","navError","initializeLobby","leaveLobby","copyLink","gameLink","encodeURIComponent","navigator","clipboard","writeText","setTimeout","textArea","document","position","left","body","appendChild","focus","select","execCommand","copyErr","removeChild","settings","initializeGameState","startGame","FirebaseTest","testScore","setTestScore","padding","addScore","marginLeft","GameReviewPage","gameData","setGameData","fetchGameData","isClassicReview","categoryDisplay","App","_gameRouteMatch$param","_lobbyRouteMatch$para","gameRouteMatch","useMatch","lobbyRouteMatch","gameCategory","params","backgroundClass","initialize","send","hitType","page","pathname","HelmetProvider","Routes","Route","element","ReactDOM","createRoot","getElementById","render","StrictMode","HashRouter"],"mappings":"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","file":"static/js/main.93c43dd2.chunk.js","sourcesContent":["module.exports = __webpack_public_path__ + \"static/media/logo.3de73253.png\";","module.exports = __webpack_public_path__ + \"static/media/population.b123bcc2.jpg\";","module.exports = __webpack_public_path__ + \"static/media/area.1a41ffef.jpg\";","module.exports = __webpack_public_path__ + \"static/media/gini.04c4aefc.jpg\";","import { initializeApp } from 'firebase/app';\nimport { getAuth } from 'firebase/auth';\nimport { getFirestore } from 'firebase/firestore';\nimport { getDatabase } from 'firebase/database';\n\nconst firebaseConfig = {\n  apiKey: process.env.REACT_APP_FIREBASE_API_KEY,\n  authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,\n  projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,\n  storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,\n  messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,\n  appId: process.env.REACT_APP_FIREBASE_APP_ID,\n  databaseURL: process.env.REACT_APP_FIREBASE_DATABASE_URL\n};\n\n// Initialize Firebase\nconst app = initializeApp(firebaseConfig);\n\n// Initialize Firebase Authentication and get a reference to the service\nexport const auth = getAuth(app);\n\n// Initialize Cloud Firestore and get a reference to the service\nexport const db = getFirestore(app);\n\n// Initialize Realtime Database and get a reference to the service\nexport const realtimeDb = getDatabase(app);\n\nexport default app; ","import React, { createContext, useState, useContext, useEffect } from 'react';\r\nimport { \r\n  createUserWithEmailAndPassword, \r\n  signInWithEmailAndPassword, \r\n  signOut, \r\n  onAuthStateChanged \r\n} from 'firebase/auth';\r\nimport { auth } from '../firebase';\r\n\r\nconst AuthContext = createContext();\r\n\r\nexport function useAuth() {\r\n  return useContext(AuthContext);\r\n}\r\n\r\nexport function AuthProvider({ children }) {\r\n  const [currentUser, setCurrentUser] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  function signup(email, password) {\r\n    return createUserWithEmailAndPassword(auth, email, password);\r\n  }\r\n\r\n  function login(email, password) {\r\n    return signInWithEmailAndPassword(auth, email, password);\r\n  }\r\n\r\n  function logout() {\r\n    return signOut(auth);\r\n  }\r\n\r\n  useEffect(() => {\r\n    const unsubscribe = onAuthStateChanged(auth, (user) => {\r\n      setCurrentUser(user);\r\n      setLoading(false);\r\n    });\r\n\r\n    return unsubscribe;\r\n  }, []);\r\n\r\n  const value = {\r\n    currentUser,\r\n    signup,\r\n    login,\r\n    logout\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={value}>\r\n      {!loading && children}\r\n    </AuthContext.Provider>\r\n  );\r\n} ","export const avatarService = {\r\n  getAvatarOptions() {\r\n    return [\r\n      {\r\n        id: 'default',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=default',\r\n        name: 'Default'\r\n      },\r\n      {\r\n        id: 'happy',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=happy',\r\n        name: 'Happy'\r\n      },\r\n      {\r\n        id: 'cool',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=cool',\r\n        name: 'Cool'\r\n      },\r\n      {\r\n        id: 'smart',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=smart',\r\n        name: 'Smart'\r\n      },\r\n      {\r\n        id: 'friendly',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=friendly',\r\n        name: 'Friendly'\r\n      },\r\n      {\r\n        id: 'adventurous',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=adventurous',\r\n        name: 'Adventurous'\r\n      },\r\n      {\r\n        id: 'creative',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=creative',\r\n        name: 'Creative'\r\n      },\r\n      {\r\n        id: 'mysterious',\r\n        url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=mysterious',\r\n        name: 'Mysterious'\r\n      }\r\n    ];\r\n  }\r\n}; ","import { doc, getDoc, setDoc, updateDoc } from 'firebase/firestore';\nimport { db } from '../firebase';\nimport { avatarService } from './avatarService';\n\nconst USERS_COLLECTION = 'users';\n\nexport const userProfileService = {\n  // Get user profile\n  async getUserProfile(userId) {\n    try {\n      const userDoc = await getDoc(doc(db, USERS_COLLECTION, userId));\n      if (userDoc.exists()) {\n        return userDoc.data();\n      }\n      // If no profile exists, create a default one\n      const defaultProfile = {\n        nickname: '',\n        country: '',\n        avatarUrl: avatarService.getAvatarOptions()[0].url,\n        createdAt: new Date()\n      };\n      await this.updateUserProfile(userId, defaultProfile);\n      return defaultProfile;\n    } catch (error) {\n      console.error('Error getting user profile:', error);\n      throw error;\n    }\n  },\n\n  // Create or update user profile\n  async updateUserProfile(userId, profileData) {\n    try {\n      const userRef = doc(db, USERS_COLLECTION, userId);\n      await setDoc(userRef, {\n        ...profileData,\n        updatedAt: new Date()\n      }, { merge: true });\n    } catch (error) {\n      console.error('Error updating user profile:', error);\n      throw error;\n    }\n  },\n\n  // Update specific profile fields\n  async updateProfileField(userId, field, value) {\n    try {\n      const userRef = doc(db, USERS_COLLECTION, userId);\n      await updateDoc(userRef, {\n        [field]: value,\n        updatedAt: new Date()\n      });\n    } catch (error) {\n      console.error('Error updating profile field:', error);\n      throw error;\n    }\n  }\n}; ","import React, { useState, useEffect } from 'react';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { userProfileService } from '../services/userProfileService';\r\nimport { avatarService } from '../services/avatarService';\r\nimport './LoginButton.css';\r\n\r\nexport default function LoginButton() {\r\n  const { currentUser, login, signup, logout } = useAuth();\r\n  const [email, setEmail] = useState('');\r\n  const [password, setPassword] = useState('');\r\n  const [error, setError] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [showLoginForm, setShowLoginForm] = useState(false);\r\n  const [userProfile, setUserProfile] = useState(null);\r\n  const navigate = useNavigate();\r\n\r\n  useEffect(() => {\r\n    const loadUserProfile = async () => {\r\n      if (currentUser) {\r\n        try {\r\n          const profile = await userProfileService.getUserProfile(currentUser.uid);\r\n          setUserProfile(profile);\r\n        } catch (error) {\r\n          console.error('Error loading user profile:', error);\r\n        }\r\n      }\r\n    };\r\n    loadUserProfile();\r\n  }, [currentUser]);\r\n\r\n  async function handleLogin(e) {\r\n    e.preventDefault();\r\n    try {\r\n      setError('');\r\n      setLoading(true);\r\n      await login(email, password);\r\n      setShowLoginForm(false);\r\n      navigate('/profile');\r\n    } catch (error) {\r\n      setError('Failed to log in: ' + error.message);\r\n    }\r\n    setLoading(false);\r\n  }\r\n\r\n  async function handleSignup(e) {\r\n    e.preventDefault();\r\n    try {\r\n      setError('');\r\n      setLoading(true);\r\n      await signup(email, password);\r\n      setShowLoginForm(false);\r\n      navigate('/profile');\r\n    } catch (error) {\r\n      setError('Failed to create an account: ' + error.message);\r\n    }\r\n    setLoading(false);\r\n  }\r\n\r\n  async function handleLogout() {\r\n    try {\r\n      setError('');\r\n      setLoading(true);\r\n      await logout();\r\n      navigate('/');\r\n    } catch (error) {\r\n      setError('Failed to log out: ' + error.message);\r\n    }\r\n    setLoading(false);\r\n  }\r\n\r\n  if (currentUser) {\r\n    return (\r\n      <div className=\"login-button\">\r\n        <div className=\"user-profile-button\" onClick={() => navigate('/profile')}>\r\n          <img \r\n            src={userProfile?.avatarUrl || avatarService.getAvatarOptions()[0].url} \r\n            alt=\"Profile\" \r\n            className=\"header-avatar\"\r\n          />\r\n          <span className=\"user-name\">{userProfile?.nickname || currentUser.email}</span>\r\n        </div>\r\n        <button onClick={handleLogout} disabled={loading} className=\"logout-button\">\r\n          Log Out\r\n        </button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"login-button\">\r\n      {!showLoginForm ? (\r\n        <button onClick={() => setShowLoginForm(true)}>\r\n          Login / Sign Up\r\n        </button>\r\n      ) : (\r\n        <div className=\"login-form\">\r\n          <input\r\n            type=\"email\"\r\n            value={email}\r\n            onChange={(e) => setEmail(e.target.value)}\r\n            placeholder=\"Email\"\r\n            required\r\n          />\r\n          <input\r\n            type=\"password\"\r\n            value={password}\r\n            onChange={(e) => setPassword(e.target.value)}\r\n            placeholder=\"Password\"\r\n            required\r\n          />\r\n          <div className=\"login-buttons\">\r\n            <button onClick={handleLogin} disabled={loading}>\r\n              Login\r\n            </button>\r\n            <button onClick={handleSignup} disabled={loading}>\r\n              Sign Up\r\n            </button>\r\n            <button onClick={() => setShowLoginForm(false)}>\r\n              Cancel\r\n            </button>\r\n          </div>\r\n          {error && <p style={{ color: 'red' }}>{error}</p>}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n} ","// src/components/Header.js\n\nimport React, { useState } from 'react';\nimport { Link, useNavigate } from 'react-router-dom';\nimport './Header.css';\nimport logo from '../assets/logo.png';\nimport LoginButton from './LoginButton';\n\n// Helper function to capitalize\nconst capitalize = (s) => s && s[0].toUpperCase() + s.slice(1);\n\nfunction Header() {\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n  const navigate = useNavigate();\n\n  const toggleMenu = () => {\n    setIsMenuOpen(!isMenuOpen);\n  };\n\n  const closeMenu = () => {\n    setIsMenuOpen(false);\n  };\n\n  // Define categories and modes for dropdowns\n  const categories = ['population', 'area', 'gini'];\n  const modes = [\n      { name: 'classic', label: 'Classic' },\n      { name: 'cooperation', label: 'Cooperation' },\n      { name: 'battleroyale', label: 'Battle Royale' },\n  ];\n\n  // Function to handle navigation, ensuring menu closes\n  const handleNav = (path, state = {}) => {\n      navigate(path, { state });\n      closeMenu();\n  };\n\n  return (\n    <header className=\"header\">\n      <div className=\"header-container\">\n        <Link to=\"/\" className=\"header-logo\" onClick={closeMenu}>\n          <img src={logo} alt=\"Sortly Logo\" className=\"logo-image\" />\n          <span className=\"site-name\">Sortly</span>\n        </Link>\n        <button className=\"menu-button\" onClick={toggleMenu}>\n          \n        </button>\n        <nav className={`header-nav ${isMenuOpen ? 'active' : ''}`}>\n          <Link to=\"/\" className=\"nav-link\" onClick={closeMenu}>Home</Link>\n          \n          {/* Generate Dropdowns from categories */}\n          {categories.map(category => (\n            <div key={category} className=\"nav-dropdown\">\n              <button className=\"nav-link dropdown-toggle\">{capitalize(category)}</button>\n              <div className=\"dropdown-menu\">\n                {modes.map(mode => (\n                  <button \n                    key={mode.name} \n                    className=\"dropdown-item\" \n                    onClick={() => handleNav(`/game/${category}/${mode.name}`, mode.name === 'classic' ? { category } : {}) }\n                  >\n                    {mode.label}\n                  </button>\n                ))}\n              </div>\n            </div>\n          ))}\n\n          <Link to=\"/leaderboard\" className=\"nav-link\" onClick={closeMenu}>Leaderboard</Link>\n          <div className=\"nav-login\">\n            <LoginButton />\n          </div>\n        </nav>\n      </div>\n    </header>\n  );\n}\n\nexport default Header;\n","// src/components/Footer.js\r\n\r\nimport React from 'react';\r\nimport './Footer.css';\r\nimport logo from '../assets/logo.png'; // Reuse your logo\r\n\r\nfunction Footer() {\r\n  return (\r\n    <footer className=\"footer\">\r\n      <div className=\"footer-container\">\r\n        <img src={logo} alt=\"Sortly Logo\" className=\"footer-logo\" />\r\n        <p>&copy; {new Date().getFullYear()} Sortly. All rights reserved.</p>\r\n      </div>\r\n    </footer>\r\n  );\r\n}\r\n\r\nexport default Footer;\r\n","\r\nimport React from 'react';\r\nimport { Helmet } from 'react-helmet-async';\r\n\r\nconst SEO = ({ title, description, keywords, image, url, type, schema }) => {\r\n  const siteTitle = 'Sortly - Interactive Country Sorting Game';\r\n  const metaDescription = description || \"Challenge yourself with Sortly, the interactive sorting game. Sort countries by population or area and test your knowledge!\";\r\n  const metaKeywords = keywords || \"sortly, sorting game, countries, population, area, game, interactive, geography\";\r\n  const metaImage = image || `${window.location.origin}/logo512.png`;\r\n  const metaUrl = url || window.location.href;\r\n  const metaType = type || 'website';\r\n\r\n  return (\r\n    <Helmet>\r\n      {/* Basic Metadata */}\r\n      <title>{title ? `${title} | Sortly` : siteTitle}</title>\r\n      <meta name=\"description\" content={metaDescription} />\r\n      <meta name=\"keywords\" content={metaKeywords} />\r\n\r\n      {/* Open Graph / Facebook */}\r\n      <meta property=\"og:type\" content={metaType} />\r\n      <meta property=\"og:url\" content={metaUrl} />\r\n      <meta property=\"og:title\" content={title || siteTitle} />\r\n      <meta property=\"og:description\" content={metaDescription} />\r\n      <meta property=\"og:image\" content={metaImage} />\r\n\r\n      {/* Twitter */}\r\n      <meta name=\"twitter:card\" content=\"summary_large_image\" />\r\n      <meta name=\"twitter:url\" content={metaUrl} />\r\n      <meta name=\"twitter:title\" content={title || siteTitle} />\r\n      <meta name=\"twitter:description\" content={metaDescription} />\r\n      <meta name=\"twitter:image\" content={metaImage} />\r\n\r\n      {/* Structured Data (JSON-LD) */}\r\n      {schema && (\r\n        <script type=\"application/ld+json\">\r\n          {JSON.stringify(schema)}\r\n        </script>\r\n      )}\r\n    </Helmet>\r\n  );\r\n};\r\n\r\nexport default SEO;\r\n","// src/pages/HomePage.js\n\nimport React from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport ReactGA from 'react-ga4'; // Import ReactGA\nimport SEO from '../components/SEO';\nimport populationImage from '../assets/population.jpg';\nimport areaImage from '../assets/area.jpg';\nimport giniImage from '../assets/gini.jpg'; // Renamed from gdpImage\nimport './HomePage.css';\n\n// Helper function to capitalize\nconst capitalize = (s) => s && s[0].toUpperCase() + s.slice(1);\n\nfunction HomePage() {\n  const navigate = useNavigate();\n\n  // Generalized handler function\n  const handlePlay = (category, mode) => {\n    const modeLabel = mode === 'battleRoyale' ? 'Battle Royale' : capitalize(mode);\n    const categoryLabel = capitalize(category);\n    const path = `/game/${category}/${mode}`;\n\n    console.log(`Navigating to: ${path}`); // For debugging\n    ReactGA.event({\n      category: 'Game Navigation', // Updated category\n      action: `Clicked Play ${categoryLabel} ${modeLabel}`,\n      label: `${categoryLabel} - ${modeLabel}`\n    });\n\n    // For classic mode, navigate directly to the game page\n    // For coop/battle, navigate to the lobby first\n    if (mode === 'classic') {\n      // Pass category in state for ClassicMode component (as it doesn't use lobbyId)\n      navigate(path, { state: { category } });\n    } else if (mode === 'cooperation' || mode === 'battleroyale') {\n      // Lobby route is now /game/:category/:mode (coop/battle)\n      navigate(path);\n    } else {\n      console.error(\"Unknown mode for navigation:\", mode);\n    }\n  };\n\n  // Define categories and modes for easier rendering\n  const categories = [\n    { name: 'population', image: populationImage },\n    { name: 'area', image: areaImage },\n    { name: 'gini', image: giniImage },\n  ];\n  const modes = ['classic', 'cooperation', 'battleroyale'];\n\n  return (\n    <div className=\"homepage\">\n      <SEO\n        title=\"Sortly - Interactive Country Sorting Game\"\n        description=\"Challenge yourself sort countries by population, area, or Gini index. Test your geography knowledge with Sortly!\"\n        keywords=\"sortly, geography game, sort countries, population, area, gini index, educational game\"\n        schema={{\n          \"@context\": \"https://schema.org\",\n          \"@type\": \"SoftwareApplication\",\n          \"name\": \"Sortly\",\n          \"applicationCategory\": \"Game\",\n          \"operatingSystem\": \"Any\",\n          \"offers\": {\n            \"@type\": \"Offer\",\n            \"price\": \"0\",\n            \"priceCurrency\": \"USD\"\n          },\n          \"publisher\": {\n            \"@type\": \"Organization\",\n            \"name\": \"Sortly\",\n            \"url\": \"https://sortly.de\",\n            \"logo\": {\n              \"@type\": \"ImageObject\",\n              \"url\": \"https://sortly.de/logo512.png\"\n            }\n          }\n        }}\n      />\n      {categories.map(cat => (\n        <div\n          key={cat.name}\n          className={`section ${cat.name}-section`}\n          style={{\n            backgroundImage: `url(${cat.image})`,\n            backgroundPosition: 'center',\n            backgroundSize: 'cover',\n            backgroundRepeat: 'no-repeat'\n          }}\n        >\n          <div className=\"overlay\">\n            <h2>Sort by {capitalize(cat.name)}</h2>\n            <div className={`mode-buttons ${cat.name}-modes`}>\n              {modes.map(mode => (\n                <button\n                  key={mode}\n                  className=\"button button-primary\"\n                  onClick={() => handlePlay(cat.name, mode)}\n                >\n                  {mode === 'battleroyale' ? 'Battle Royale' : capitalize(mode)} Mode\n                </button>\n              ))}\n            </div>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n\nexport default HomePage;\n","// src/api/countriesApi.js\n\n// Helper function to get the latest Gini value from the object\nconst getLatestGini = (giniObj) => {\n  if (!giniObj || typeof giniObj !== 'object' || Object.keys(giniObj).length === 0) {\n    return null;\n  }\n  // Find the latest year (key)\n  const latestYear = Object.keys(giniObj).sort().pop();\n  const giniValue = giniObj[latestYear];\n  return typeof giniValue === 'number' ? giniValue : null;\n};\n\nexport const fetchCountries = async () => {\n  try {\n    // Update URL to request specific fields, including gini\n    const apiUrl = 'https://restcountries.com/v3.1/all?fields=name,flags,population,area,gini,unMember';\n    const response = await fetch(apiUrl);\n    if (!response.ok) {\n      throw new Error(`HTTP error! status: ${response.status}`);\n    }\n    const data = await response.json();\n    if (!Array.isArray(data)) {\n      throw new Error('Invalid data format received from API');\n    }\n\n    // Filter to only include UN member states with valid data for ALL required fields\n    const validCountries = data.filter((country) => {\n      const latestGini = getLatestGini(country.gini); // Get latest Gini value\n      return (\n        country.unMember && \n        country.name?.common && \n        country.flags?.svg && \n        typeof country.population === 'number' && \n        typeof country.area === 'number' &&\n        latestGini !== null // Check if we got a valid Gini number\n      );\n    });\n\n    // Map the API data, including the extracted Gini value\n    const countries = validCountries.map((country, index) => ({\n      id: country.name.common, \n      name: country.name.common,\n      flagUrl: country.flags.svg,\n      population: country.population,\n      area: country.area,\n      gini: getLatestGini(country.gini), // Add latest Gini value here\n    }));\n\n    console.log(`Fetched ${countries.length} countries with valid Pop, Area, and Gini.`); // Log count\n\n    // Add a check here to ensure we still have enough countries after filtering\n    if (countries.length < 2) {\n        console.warn('Fetched fewer than 2 countries with valid data including Gini.');\n        // throw new Error('Insufficient country data available after filtering for Gini.');\n    }\n\n    return countries;\n  } catch (error) {\n    console.error('Error fetching countries:', error);\n    throw new Error('Failed to fetch countries data. Please try again later.');\n  }\n};\n  ","// src/components/CountryCard.js\n\nimport React, { useState } from 'react';\nimport './CountryCard.css';\n\nfunction CountryCard({ \n  country, \n  mode, // category: population, area, gini\n  statisticValue, // The actual value for the current mode\n  isFlippable, // Can this card be flipped? (For sorted cards)\n  isClickable, // Can this card be clicked to choose/place? (For remaining/current cards)\n  highlight, \n  onClick, // Function to call when choosing/placing\n  customClassName \n}) {\n  const [isFlipped, setIsFlipped] = useState(false);\n\n  const handleClick = () => {\n    if (isFlippable) {\n      // If it's flippable, just toggle the flip state\n      setIsFlipped(!isFlipped);\n    } else if (isClickable && onClick) {\n      // Otherwise, if it's clickable for choosing/placing, call the onClick prop\n      onClick();\n    }\n    // If neither flippable nor clickable, do nothing\n  };\n\n  const highlightClass = highlight ? `highlighted-${highlight}` : '';\n\n  // Format numbers nicely\n  const formatNumber = (num) => {\n    if (typeof num !== 'number') return '';\n    // Gini usually shown to 1 decimal place, others as integers\n    return mode === 'gini' ? num.toFixed(1) : num.toLocaleString();\n  };\n\n  const getDetailText = () => {\n    const value = formatNumber(statisticValue);\n    switch (mode) {\n      case 'population':\n        return `Population: ${value}`;\n      case 'area':\n        return `Area: ${value} km`;\n      case 'gini':\n        // Assuming Gini is passed as a number like 35.1\n        return `Gini Index: ${value}`;\n      default:\n        return '';\n    }\n  };\n\n  return (\n    <div\n      // Add 'flippable' class if applicable for styling cursor etc.\n      className={`country-card ${isFlippable ? 'flippable' : ''} ${isFlipped ? 'flipped' : ''} ${\n        isClickable ? 'clickable' : '' // Keep clickable for remaining cards styling\n      } ${highlightClass} ${customClassName || ''}`}\n      onClick={handleClick}\n    >\n      <div className=\"card-inner\">\n        {/* Front Side */}\n        <div className={`card-face card-front ${highlightClass}`}>\n          <img\n            src={country.flagUrl}\n            alt={`Flag of ${country.name}`}\n            className=\"country-flag\"\n          />\n          <div className=\"country-info\">\n            <h3 className=\"country-name\">{country.name}</h3>\n          </div>\n        </div>\n        {/* Back Side */}\n        <div className={`card-face card-back ${highlightClass}`}>\n          <div className=\"country-info\">\n            <h3 className=\"country-name\">{country.name}</h3>\n            {/* Display the formatted detail text */}\n            <p className=\"country-detail\">\n              {getDetailText()}\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default CountryCard;\n","import React from 'react';\r\nimport { useDrag, useDrop } from 'react-dnd';\r\nimport CountryCard from '../CountryCard';\r\n\r\nexport const ItemTypes = {\r\n    CARD: 'card',\r\n};\r\n\r\nexport const DraggableCard = ({ country, mode, statisticValue }) => {\r\n    const [{ isDragging }, drag] = useDrag(() => ({\r\n        type: ItemTypes.CARD,\r\n        item: { country },\r\n        collect: (monitor) => ({\r\n            isDragging: !!monitor.isDragging(),\r\n        }),\r\n    }));\r\n\r\n    return (\r\n        <div\r\n            ref={drag}\r\n            style={{\r\n                opacity: isDragging ? 0.5 : 1,\r\n                cursor: 'move',\r\n                width: '100%',\r\n                maxWidth: '220px', // Match existing card width roughly\r\n                display: 'flex', // Enable flex\r\n                justifyContent: 'center', // Center content horizontally\r\n                alignItems: 'center' // Center content vertically\r\n            }}\r\n        >\r\n            <CountryCard\r\n                country={country}\r\n                mode={mode}\r\n                statisticValue={statisticValue}\r\n                isFlippable={false}\r\n                isClickable={false}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport const DropZone = ({ onDrop, index, isEmpty }) => {\r\n    const [{ isOver, canDrop }, drop] = useDrop(() => ({\r\n        accept: ItemTypes.CARD,\r\n        drop: (item) => onDrop(index, item.country),\r\n        collect: (monitor) => ({\r\n            isOver: !!monitor.isOver(),\r\n            canDrop: !!monitor.canDrop(),\r\n        }),\r\n    }));\r\n\r\n    let className = 'drop-zone';\r\n    if (isOver && canDrop) {\r\n        className += ' active-drop';\r\n    }\r\n    if (isEmpty) {\r\n        className += ' empty-drop';\r\n    }\r\n\r\n    return (\r\n        <div\r\n            ref={drop}\r\n            className={className}\r\n        >\r\n            {/* Visual indicator handled by CSS */}\r\n        </div>\r\n    );\r\n};\r\n","/**\r\n * Capitalizes the first letter of a string.\r\n * @param {string} s The string to capitalize.\r\n * @returns {string} The capitalized string, or the original string if input is invalid.\r\n */\r\nexport const capitalize = (s) => {\r\n  if (typeof s !== 'string' || s.length === 0) {\r\n    return s; // Return original value if not a non-empty string\r\n  }\r\n  return s.charAt(0).toUpperCase() + s.slice(1);\r\n}; ","import React, { useState, useEffect, useCallback } from 'react';\nimport { useNavigate } from 'react-router-dom'; // Removed useLocation\nimport { fetchCountries } from '../../api/countriesApi'; // Adjusted path\nimport CountryCard from '../CountryCard'; // Adjusted path\nimport { DraggableCard, DropZone } from './DragComponents';\nimport { capitalize } from '../../utils/stringUtils'; // Import from the new utility file\nimport '../../pages/GamePage.css'; // Adjusted path, consider a dedicated CSS?\n\n// Renamed component, accepts category as a prop\nfunction ClassicMode({ category = 'population' }) { // Receive category as prop, default\n  const [countriesToPick, setCountriesToPick] = useState([]);\n  const [sortedCountries, setSortedCountries] = useState([]);\n  const [currentCountry, setCurrentCountry] = useState(null);\n  const [score, setScore] = useState(0);\n  const [gameStatus, setGameStatus] = useState('loading'); // loading, picking, placing, ended\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const navigate = useNavigate();\n  // Removed: const location = useLocation();\n  // Removed: const category = location.state?.category || 'population'; \n\n  useEffect(() => {\n    // loadGame logic remains largely the same, uses the category prop\n    const loadGame = async () => {\n      setIsLoading(true);\n      setError(null);\n      try {\n        const fetchedCountries = await fetchCountries();\n        // Filter countries that don't have the required category data?\n        const validCountries = fetchedCountries.filter(c => typeof c[category] !== 'undefined' && c[category] !== null);\n\n        if (validCountries.length < 2) {\n          setError(`Not enough countries found with valid data for category: ${category}.`);\n          setGameStatus('ended');\n          setIsLoading(false);\n          return; // Stop loading process\n        }\n\n        const shuffled = validCountries.sort(() => 0.5 - Math.random());\n\n        // Start the game with the first country already sorted\n        // Sort initial country and first to place based on the category\n        const sortedInitialPair = [shuffled[0], shuffled[1]].sort((a, b) => (a[category] ?? 0) - (b[category] ?? 0));\n        const initialSortedCountry = sortedInitialPair[0];\n        const firstCountryToPlace = sortedInitialPair[1];\n\n        setSortedCountries([initialSortedCountry]); // Start with the first country placed\n        setCurrentCountry(firstCountryToPlace); // Set the second country as the one to place\n        // Shuffle the rest\n        setCountriesToPick(shuffled.slice(2).sort(() => 0.5 - Math.random()));\n        setScore(1); // Start score at 1\n        setGameStatus('placing');\n\n      } catch (err) {\n        console.error(`Failed to load countries for category ${category}:`, err);\n        setError(err.message || `Failed to load game data for ${category}.`);\n        setGameStatus('ended');\n      } finally {\n        setIsLoading(false);\n      }\n    };\n    loadGame();\n  }, [category]); // Dependency is now only category\n\n  // Wrap pickNextCountry in useCallback\n  const pickNextCountry = useCallback(() => {\n    if (countriesToPick.length > 0) {\n      const nextCountry = countriesToPick[0];\n      setCurrentCountry(nextCountry);\n      setCountriesToPick(countriesToPick.slice(1));\n      setGameStatus('placing');\n    } else {\n      // All countries sorted correctly!\n      setGameStatus('ended');\n      navigate('/gameover', {\n        state: {\n          score: score,\n          message: `Congratulations! You sorted all countries by ${category === 'gini' ? 'Gini index' : capitalize(category)}!`, // Adjusted message\n          category: category,\n          gameMode: `classic_${category}`\n        },\n        replace: true\n      });\n    }\n  }, [countriesToPick, score, category, navigate]); // Add dependencies of pickNextCountry\n\n  const handlePlaceCountry = (index) => {\n    if (!currentCountry || gameStatus !== 'placing') return;\n\n    const countryToPlace = currentCountry;\n    const newSortedCountries = [...sortedCountries];\n    newSortedCountries.splice(index, 0, countryToPlace);\n\n    // Check if the new placement is correct based on the dynamic category prop\n    let isCorrect = true;\n    if (index > 0) { // Check predecessor\n      isCorrect = isCorrect && (newSortedCountries[index - 1][category] ?? 0) <= (countryToPlace[category] ?? 0);\n    }\n    if (index < newSortedCountries.length - 1) { // Check successor\n      isCorrect = isCorrect && (countryToPlace[category] ?? 0) <= (newSortedCountries[index + 1][category] ?? 0);\n    }\n\n    if (isCorrect) {\n      setSortedCountries(newSortedCountries);\n      setScore(score + 1);\n      setCurrentCountry(null);\n      setGameStatus('picking'); // Go to picking state first\n    } else {\n      // Capture state *before* navigating\n      const finalSortedList = [...sortedCountries];\n      const incorrectCountry = countryToPlace;\n      const attemptedIndex = index;\n\n      // Construct the user's attempted order for history/display\n      const userOrder = [...sortedCountries];\n      userOrder.splice(index, 0, incorrectCountry);\n\n      setGameStatus('ended');\n      navigate('/gameover', {\n        state: {\n          score: score,\n          message: `Incorrect placement based on ${category === 'gini' ? 'Gini index' : capitalize(category)}. Game Over!`, // Adjusted message\n          category: category,\n          gameMode: `classic_${category}`,\n          finalSortedList: finalSortedList,\n          incorrectCountry: incorrectCountry,\n          attemptedIndex: attemptedIndex,\n          userOrder: userOrder // Pass the constructed user order\n        },\n        replace: true\n      });\n    }\n  };\n\n  // Effect to automatically pick next country when in 'picking' state\n  useEffect(() => {\n    if (gameStatus === 'picking') {\n      pickNextCountry();\n    }\n  }, [gameStatus, pickNextCountry]); // Add pickNextCountry to dependencies\n\n  if (isLoading) {\n    // Use a generic class, GamePage can add wrapper styles\n    return <div className=\"game-mode-loading\">Loading Classic Game...</div>;\n  }\n\n  if (error) {\n    return <div className=\"game-mode-error\">Error: {error} <button onClick={() => window.location.reload()}>Retry</button></div>;\n  }\n\n  // Removed ended state check here, assume parent handles navigation\n  // if (gameStatus === 'ended' && !isLoading) { ... }\n\n  return (\n    // Use a common class for game mode components\n    <div className=\"game-mode classic-mode\">\n      <h2>Classic Mode - Sort by {category === 'gini' ? 'Gini Index' : capitalize(category)} (Lowest to Highest)</h2>\n      <p>Score: {score > 0 ? score - 1 : 0}</p>\n\n\n      <div className=\"sorted-countries-container\">\n\n        <div className=\"sorted-countries\">\n          {/* Initial Drop Zone at the start */}\n          {currentCountry && gameStatus === 'placing' && (\n            <DropZone\n              index={0}\n              onDrop={(idx) => handlePlaceCountry(idx)}\n              isEmpty={sortedCountries.length === 0}\n            />\n          )}\n\n          {sortedCountries.map((country, index) => (\n            <React.Fragment key={`fragment-${country.id}`}>\n              <CountryCard\n                country={country}\n                mode={category}\n                statisticValue={country[category]}\n                isFlippable={true}\n                isClickable={false}\n              />\n              {/* Drop Zone after each card */}\n              {currentCountry && gameStatus === 'placing' && (\n                <DropZone\n                  index={index + 1}\n                  onDrop={(idx) => handlePlaceCountry(idx)}\n                />\n              )}\n            </React.Fragment>\n          ))}\n        </div>\n      </div>\n\n      {gameStatus === 'placing' && currentCountry && (\n        <div className=\"current-country\">\n          <h3>Drag this Country to Place It:</h3>\n          <div\n            className=\"current-country-wrapper\"\n            title={`${currentCountry.name} - drag me!`}\n            style={{ maxWidth: '220px', margin: '0 auto' }}\n          >\n            <DraggableCard\n              country={currentCountry}\n              mode={category}\n              statisticValue={currentCountry[category]}\n            />\n          </div>\n        </div>\n      )}\n      {/* Instructions could be added */}\n      {/* <div className=\"game-instructions\"> ... </div> */}\n\n    </div>\n  );\n}\n\nexport default ClassicMode; ","import { realtimeDb } from '../firebase';\nimport { ref, set, update, onValue, off, get } from 'firebase/database';\nimport { fetchCountries } from '../api/countriesApi'; // Import fetchCountries here\n\nconst GAME_STATES_PATH = 'gameStates';\n\n// Helper to get random elements without mutation\nconst getRandomElements = (arr, num) => {\n  if (num > arr.length) {\n    console.warn(\"Requested more elements than available\");\n    num = arr.length;\n  }\n  const shuffled = [...arr].sort(() => 0.5 - Math.random());\n  return shuffled.slice(0, num);\n};\n\nexport const cooperationGameService = {\n  // Initialize a new game state for cooperation mode\n  async initializeGameState(lobbyId, players, category = 'population') {\n    // Fetch all countries within the service\n    let allCountries;\n    try {\n      allCountries = await fetchCountries();\n      // Sort countries by the selected category initially\n      // This ensures the initial card and inventory make sense for the category\n      allCountries.sort((a, b) => (a[category] ?? 0) - (b[category] ?? 0)); \n\n      if (!allCountries || allCountries.length < 11) { // Need at least 11\n        throw new Error(`Not enough valid countries fetched to start cooperation mode for category ${category}.`);\n      }\n    } catch (fetchError) {\n      console.error(\"Failed to fetch countries for initialization:\", fetchError);\n      throw new Error(`Could not fetch country data for category ${category} to start the game.`);\n    }\n\n    // Select 11 countries (1 initial + 10 inventory) - Now uses the sorted list\n    const selectedCountries = getRandomElements(allCountries, 11); // Select randomly from category-sorted list\n    const initialCountry = selectedCountries[0];\n    const inventoryCountries = selectedCountries.slice(1).sort((a, b) => 0.5 - Math.random()); // Shuffle inventory\n\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const initialState = {\n      lobbyId: lobbyId, // Store lobbyId for reference\n      category: category, // Store the category\n      currentPlayer: players[0].id, // First player starts\n      players: players,\n      mode: 'choosing', // Start in choosing mode\n      sortedCountries: [initialCountry], // Start with one country sorted\n      remainingCountries: inventoryCountries, // The 10 countries in inventory\n      currentCountry: null, // No country chosen to place yet\n      score: 1, // Started with 1 country sorted\n      status: 'playing',\n      createdAt: Date.now(),\n      lastUpdated: Date.now()\n    };\n\n    await set(gameStateRef, initialState);\n    console.log(`Initialized ${category} cooperation game state for lobby`, lobbyId);\n    // No need to return initialState, changes propagate via subscription\n  },\n\n  // Subscribe to game state changes\n  subscribeToGameState(lobbyId, callback) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const listener = onValue(gameStateRef, (snapshot) => {\n      const data = snapshot.val();\n      callback(data); // Pass data (or null if deleted) to callback\n    }, (error) => {\n      console.error(\"Error subscribing to game state:\", error);\n      callback(null); // Notify callback of error/disconnection\n    });\n\n    // Return unsubscribe function\n    return () => off(gameStateRef, 'value', listener);\n  },\n\n  // Update game state (internal helper - might not be needed externally anymore)\n  async updateGameState(lobbyId, updates) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    await update(gameStateRef, {\n      ...updates,\n      lastUpdated: Date.now()\n    });\n  },\n\n  // Player chooses a card from the inventory\n  async chooseCard(lobbyId, playerId, chosenCountry) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const snapshot = await get(gameStateRef);\n    const gameState = snapshot.val();\n\n    if (!gameState || gameState.status !== 'playing') {\n      throw new Error('Game is not active or not found');\n    }\n    if (gameState.mode !== 'choosing') {\n      throw new Error('Not in choosing mode');\n    }\n    if (gameState.currentPlayer !== playerId) {\n      throw new Error('Not your turn to choose');\n    }\n    // Verify the chosen country ID exists in the remaining list\n    if (!gameState.remainingCountries || !gameState.remainingCountries.some(c => c.id === chosenCountry.id)) {\n       console.error(\"Chosen country ID not found in remaining:\", chosenCountry?.id, gameState.remainingCountries);\n       throw new Error('Chosen country is not valid or not in the remaining inventory');\n    }\n\n    await update(gameStateRef, {\n      currentCountry: chosenCountry, // Set the chosen country as the one to be placed\n      mode: 'placing', // Switch mode to placing\n      lastUpdated: Date.now()\n    });\n  },\n\n  // Player places the chosen card into the sorted list\n  async placeCard(lobbyId, playerId, placementIndex) {\n    // placementIndex is the index where the player wants to insert the currentCountry\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const snapshot = await get(gameStateRef);\n    const gameState = snapshot.val();\n\n    if (!gameState || gameState.status !== 'playing') {\n      throw new Error('Game is not active or not found');\n    }\n    if (gameState.mode !== 'placing') {\n      throw new Error('Not in placing mode');\n    }\n    if (gameState.currentPlayer !== playerId) {\n      throw new Error('Not your turn to place');\n    }\n    if (!gameState.currentCountry) {\n        throw new Error('No country currently chosen for placement');\n    }\n    if (typeof placementIndex !== 'number' || placementIndex < 0 || placementIndex > gameState.sortedCountries.length) {\n      console.error(\"Invalid placement index received:\", placementIndex, \"Current sorted length:\", gameState.sortedCountries.length);\n      throw new Error('Invalid placement index');\n    }\n    // Get the category from the game state\n    const category = gameState.category || 'population'; // Default to population if somehow missing\n\n    // Construct the potential new sorted list based on the placement index\n    const potentialNewSortedCountries = [...gameState.sortedCountries];\n    potentialNewSortedCountries.splice(placementIndex, 0, gameState.currentCountry);\n\n    // Server-side validation of the placement (using category from gameState)\n    const isCorrect = (countriesList) => {\n      // Check if countriesList is valid before accessing length\n      if (!Array.isArray(countriesList)) {\n        console.error(\"isCorrect received non-array:\", countriesList);\n        return false; // Or handle as appropriate\n      }\n      for (let i = 0; i < countriesList.length - 1; i++) {\n        // Add checks for country objects and the compare property (using category)\n        if (!countriesList[i] || !countriesList[i+1] ||\n            typeof countriesList[i][category] === 'undefined' || // Use category\n            typeof countriesList[i+1][category] === 'undefined' || // Use category\n            countriesList[i][category] > countriesList[i + 1][category]) { // Use category\n          console.warn(`Incorrect order found at index ${i} for category ${category}:`, countriesList[i][category], countriesList[i+1][category]);\n          return false;\n        }\n      }\n      return true;\n    };\n\n    if (isCorrect(potentialNewSortedCountries)) {\n      // Correct Placement\n\n      // --- Start: Added logic to remove placed card from remaining --- \n      // Ensure we have the country that was just placed and the remaining list\n      const placedCountryId = gameState.currentCountry.id;\n      let updatedRemainingCountries = gameState.remainingCountries || [];\n\n      // Filter out the placed country from the remaining list\n      updatedRemainingCountries = updatedRemainingCountries.filter(country => country.id !== placedCountryId);\n      // --- End: Added logic --- \n\n      // Determine the next player correctly, ensuring players array exists\n      let nextPlayerId = gameState.players[0]?.id; // Default to first player if only one or issues\n      if (gameState.players.length > 1) {\n          const currentPlayerIndex = gameState.players.findIndex(p => p.id === playerId);\n          nextPlayerId = gameState.players[(currentPlayerIndex + 1) % gameState.players.length].id;\n      }\n\n      const updates = {\n        currentPlayer: nextPlayerId,\n        sortedCountries: potentialNewSortedCountries, // Update the sorted list\n        remainingCountries: updatedRemainingCountries, // Update the remaining list\n        currentCountry: null, // Clear the placed country\n        mode: 'choosing', // Go back to choosing mode\n        score: gameState.score + 1,\n        lastUpdated: Date.now()\n      };\n\n      // Check for win condition (newly updated inventory empty AND placed correctly)\n      if (updatedRemainingCountries.length === 0) {\n        updates.status = 'completed';\n        updates.result = 'win';\n        updates.mode = 'finished'; // Or some final mode\n      }\n\n      await update(gameStateRef, updates);\n\n    } else {\n      // Incorrect Placement - End Game\n      console.log(`Incorrect placement by ${playerId}. Ending game.`);\n      await this.endGame(lobbyId); // Call endGame directly\n    }\n  },\n\n  // End game (can be called on incorrect placement or explicitly)\n  async endGame(lobbyId) { // No longer needs playerId here if called internally\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    // Check if game exists before updating\n    const snapshot = await get(gameStateRef);\n    if (snapshot.exists() && snapshot.val().status === 'playing') {\n      await update(gameStateRef, {\n        status: 'completed',\n        result: 'lose',\n        mode: 'finished',\n        currentCountry: null, // Ensure no country is stuck in current\n        lastUpdated: Date.now()\n      });\n      console.log(\"Game ended with lose state for lobby:\", lobbyId);\n    } else {\n       console.log(\"Game already completed or does not exist, skipping endGame call for lobby:\", lobbyId);\n    }\n  },\n\n  // Clean up game state\n  async cleanupGameState(lobbyId) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    await set(gameStateRef, null);\n  }\n}; ","import React, { useState, useEffect } from 'react';\r\nimport CountryCard from '../CountryCard'; // Adjusted path\r\nimport '../../pages/GamePage.css'; // Adjusted path\r\nimport { useNavigate } from 'react-router-dom'; // Removed useLocation\r\nimport { useAuth } from '../../contexts/AuthContext'; // Adjusted path\r\nimport { cooperationGameService } from '../../services/cooperationGameService'; // Adjusted path\r\n\r\n// Helper function to capitalize\r\nconst capitalize = (s) => s && s[0].toUpperCase() + s.slice(1);\r\n\r\n// Renamed component, accepts lobbyId and category as props\r\nfunction CooperationMode({ lobbyId, category: categoryProp = 'population' }) { \r\n  const { currentUser } = useAuth();\r\n  const [sortedCountries, setSortedCountries] = useState([]);\r\n  const [currentCountry, setCurrentCountry] = useState(null);\r\n  const [remainingCountries, setRemainingCountries] = useState([]);\r\n  const [score, setScore] = useState(0);\r\n  const [gameState, setGameState] = useState('waiting'); // waiting, playing, ended\r\n  const [gameStateData, setGameStateData] = useState(null); // Store full game state\r\n  const navigate = useNavigate();\r\n  // Removed location logic\r\n  \r\n  // Determine category primarily from gameStateData once loaded, fallback to prop\r\n  const category = gameStateData?.category || categoryProp;\r\n\r\n  useEffect(() => {\r\n    // Validate lobbyId passed as prop\r\n    if (!lobbyId) { \r\n      console.error(\"CooperationMode requires a lobbyId prop.\");\r\n      // Optionally navigate away or show error\r\n      navigate('/'); \r\n      return;\r\n    }\r\n\r\n    // Subscribe to the game state from Firebase\r\n    const unsubscribe = cooperationGameService.subscribeToGameState(lobbyId, (data) => {\r\n      if (data) {\r\n        setGameStateData(data);\r\n        setScore(data.score !== undefined ? data.score : 0);\r\n        setSortedCountries(data.sortedCountries || []);\r\n        setCurrentCountry(data.currentCountry || null); // The country to be placed\r\n        setRemainingCountries(data.remainingCountries || []);\r\n        setGameState(data.status || 'waiting'); // Use status from DB\r\n        const currentCategory = data.category || 'population'; // Get category from data\r\n\r\n        // Handle game completion based on status from DB\r\n        if (data.status === 'completed') {\r\n           let message = 'Game Over!';\r\n           let finalScore = data.score || 0; // Use score from data\r\n           const messageCategory = currentCategory === 'gini' ? 'Gini index' : capitalize(currentCategory);\r\n\r\n           if (data.result === 'win') {\r\n             message = `Congratulations! You sorted all countries correctly by ${messageCategory}.`;\r\n           } else if (data.result === 'lose') {\r\n             message = `Game Over! An incorrect move was made while sorting by ${messageCategory}.`;\r\n           }\r\n           \r\n           navigate('/gameover', {\r\n              state: { \r\n                score: finalScore, \r\n                message: message,\r\n                category: currentCategory, \r\n                gameMode: `cooperation_${currentCategory}` \r\n              }, \r\n              replace: true\r\n            });\r\n        }\r\n\r\n      } else {\r\n        console.error(\"Game state not found for lobby:\", lobbyId);\r\n        navigate('/'); // Navigate away if game state disappears\r\n      }\r\n    });\r\n\r\n    // Cleanup subscription on unmount\r\n    return () => unsubscribe();\r\n\r\n  }, [lobbyId, navigate, currentUser]); // Dependency is now lobbyId\r\n\r\n  // Handler for when a player chooses a card from the inventory\r\n  const handleChooseCard = async (country) => {\r\n    if (!gameStateData || !currentUser) return;\r\n    if (gameStateData.currentPlayer !== currentUser.uid) return; // Not their turn\r\n    if (gameStateData.mode !== 'choosing') return; // Wrong mode\r\n\r\n    try {\r\n      await cooperationGameService.chooseCard(gameStateData.lobbyId, currentUser.uid, country);\r\n    } catch (error) {\r\n      console.error(\"Error choosing card:\", error);\r\n    }\r\n  };\r\n\r\n  // Handler for placing a card in the sorted list\r\n  const handlePlaceCard = async (index) => {\r\n    if (!gameStateData || !currentUser || !currentCountry) return;\r\n    if (gameStateData.currentPlayer !== currentUser.uid) return; // Not their turn\r\n    if (gameStateData.mode !== 'placing') return; // Wrong mode\r\n\r\n    try {\r\n      await cooperationGameService.placeCard(gameStateData.lobbyId, currentUser.uid, index);\r\n    } catch (error) {\r\n      console.error(\"Error placing card:\", error);\r\n    }\r\n  };\r\n\r\n  // Loading state based on gameStateData instead of separate isLoading flag\r\n  if (!gameStateData || gameState === 'waiting') {\r\n    return <div className=\"game-mode-loading\">Loading Cooperation Game...</div>;\r\n  }\r\n\r\n  const isMyTurn = gameStateData.currentPlayer === currentUser?.uid;\r\n  const currentPlayerName = gameStateData.players?.find(p => p.id === gameStateData.currentPlayer)?.name || 'Unknown';\r\n  const canPlace = gameStateData.mode === 'placing' && isMyTurn && currentCountry;\r\n\r\n  return (\r\n    <div className=\"game-mode cooperation-mode\"> {/* Add specific class */}\r\n      <h2>Cooperation Mode - Sort by {category === 'gini' ? 'Gini Index' : capitalize(category)}</h2>\r\n      <p>Current Turn: {currentPlayerName}</p>\r\n      <p>Score: {score}</p>\r\n\r\n      {/* Display sorted countries */}\r\n      <div className=\"sorted-countries-container\">\r\n        <h3>Sorted Countries:</h3>\r\n        <div className=\"sorted-countries\">\r\n          {canPlace && (\r\n            <button\r\n              className=\"place-button plus-button\"\r\n              onClick={() => handlePlaceCard(0)}\r\n              aria-label=\"Place card at the beginning\"\r\n            >\r\n              +\r\n            </button>\r\n          )}\r\n          {sortedCountries.map((country, index) => (\r\n            <React.Fragment key={`sorted-fragment-${country.id}`}>\r\n              <CountryCard\r\n                country={country}\r\n                mode={category}\r\n                statisticValue={country[category]}\r\n                isFlippable={true}\r\n                isClickable={false}\r\n              />\r\n              {canPlace && (\r\n                <button\r\n                  className=\"place-button plus-button\"\r\n                  onClick={() => handlePlaceCard(index + 1)}\r\n                  aria-label={`Place card after ${country.name}`}\r\n                >\r\n                  +\r\n                </button>\r\n              )}\r\n            </React.Fragment>\r\n          ))}\r\n          {sortedCountries.length === 0 && canPlace && (\r\n             <button\r\n                className=\"place-button plus-button\"\r\n                onClick={() => handlePlaceCard(0)}\r\n                aria-label=\"Place first card\"\r\n             >\r\n               +\r\n             </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Display remaining countries */}\r\n      <div className=\"remaining-countries\">\r\n        <h3>Remaining Countries to Sort: ({remainingCountries.length})</h3>\r\n        <div className=\"remaining-countries-grid\">\r\n          {remainingCountries.map((country) => {\r\n            const isSelectedForPlacing = gameStateData.mode === 'placing' && currentCountry && country.id === currentCountry.id;\r\n            return (\r\n              <CountryCard\r\n                key={`remaining-${country.id}`}\r\n                country={country}\r\n                mode={category}\r\n                statisticValue={country[category]}\r\n                isFlippable={false}\r\n                isClickable={gameStateData.mode === 'choosing' && isMyTurn}\r\n                onClick={() => gameStateData.mode === 'choosing' && isMyTurn && handleChooseCard(country)}\r\n                customClassName={isSelectedForPlacing ? 'selected-for-placing' : ''}\r\n              />\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Game instructions */}\r\n      <div className=\"game-instructions\">\r\n        {gameStateData.mode === 'choosing' && (\r\n          isMyTurn ? (\r\n            <p>Choose a country from the remaining countries to place next.</p>\r\n          ) : (\r\n            <p>Waiting for {currentPlayerName} to choose a country...</p>\r\n          )\r\n        )}\r\n        {gameStateData.mode === 'placing' && (\r\n          isMyTurn ? (\r\n            <p>Place {currentCountry?.name} in the correct position based on {category === 'gini' ? 'Gini index' : category}.</p>\r\n          ) : (\r\n            <p>Waiting for {currentPlayerName} to place {currentCountry?.name}...</p>\r\n          )\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default CooperationMode; ","import { realtimeDb } from '../firebase';\nimport { ref, set, update, onValue, off, get } from 'firebase/database';\nimport { fetchCountries } from '../api/countriesApi'; \n\n// Use a separate path for Battle Royale game states\nconst GAME_STATES_PATH = 'battleRoyaleGameStates'; \n\n// Helper to get random elements without mutation\nconst getRandomElements = (arr, num) => {\n  if (num > arr.length) {\n    console.warn(\"Requested more elements than available\");\n    num = arr.length;\n  }\n  const shuffled = [...arr].sort(() => 0.5 - Math.random());\n  return shuffled.slice(0, num);\n};\n\nexport const battleRoyaleGameService = {\n  // Initialize a new game state for battle royale mode\n  async initializeGameState(lobbyId, players, category = 'population') {\n    // Validate player count (2-8)\n    if (players.length < 2 || players.length > 8) {\n      throw new Error('Battle Royale mode requires between 2 and 8 players.');\n    }\n      \n    // Fetch all countries within the service\n    let allCountries;\n    const requiredCountries = 26; // 1 initial + 25 inventory\n    try {\n      allCountries = await fetchCountries();\n      // Sort countries by the selected category initially\n      allCountries.sort((a, b) => (a[category] ?? 0) - (b[category] ?? 0));\n\n      if (!allCountries || allCountries.length < requiredCountries) {\n        throw new Error(`Not enough valid countries fetched to start Battle Royale mode for category ${category}. Need ${requiredCountries}.`);\n      }\n    } catch (fetchError) {\n      console.error(\"Failed to fetch countries for initialization:\", fetchError);\n      throw new Error(`Could not fetch country data for category ${category} to start the game.`);\n    }\n\n    // Select 26 countries (1 initial + 25 inventory) - From category-sorted list\n    const selectedCountries = getRandomElements(allCountries, requiredCountries); \n    const initialCountry = selectedCountries[0];\n    const inventoryCountries = selectedCountries.slice(1).sort((a, b) => 0.5 - Math.random()); // Shuffle inventory\n\n    // Initialize players with active status\n    const initialPlayers = players.map(p => ({ ...p, isActive: true, score: 0 })); // Add isActive flag and individual score\n\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const initialState = {\n      lobbyId: lobbyId, \n      category: category, // Store the category\n      gameType: 'battleRoyale', // Identify the game type\n      currentPlayer: initialPlayers[0].id, // First active player starts\n      players: initialPlayers, \n      activePlayers: initialPlayers.map(p => p.id), // Keep track of active player IDs\n      mode: 'choosing', // Start in choosing mode\n      sortedCountries: [initialCountry], // Start with one country sorted\n      remainingCountries: inventoryCountries, // The 25 countries in inventory\n      currentCountry: null, // No country chosen to place yet\n      // score: 1, // Score is per-player\n      status: 'playing',\n      createdAt: Date.now(),\n      lastUpdated: Date.now()\n    };\n\n    await set(gameStateRef, initialState);\n    console.log(`Initialized ${category} Battle Royale game state for lobby`, lobbyId, `at path ${GAME_STATES_PATH}/${lobbyId}`);\n  },\n\n  // Subscribe to game state changes (Likely reusable)\n  subscribeToGameState(lobbyId, callback) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const listener = onValue(gameStateRef, (snapshot) => {\n      const data = snapshot.val();\n      callback(data); \n    }, (error) => {\n      console.error(\"Error subscribing to game state:\", error);\n      callback(null); \n    });\n    return () => off(gameStateRef, 'value', listener);\n  },\n\n  // Update game state (Likely reusable)\n  async updateGameState(lobbyId, updates) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    await update(gameStateRef, {\n      ...updates,\n      lastUpdated: Date.now()\n    });\n  },\n\n  // Player chooses a card from the inventory (Likely reusable, maybe add active check)\n  async chooseCard(lobbyId, playerId, chosenCountry) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const snapshot = await get(gameStateRef);\n    const gameState = snapshot.val();\n\n    if (!gameState || gameState.status !== 'playing') throw new Error('Game is not active or not found');\n    if (gameState.mode !== 'choosing') throw new Error('Not in choosing mode');\n    if (gameState.currentPlayer !== playerId) throw new Error('Not your turn to choose');\n    \n    // Ensure the player is active\n    const choosingPlayer = gameState.players.find(p => p.id === playerId);\n    if (!choosingPlayer || !choosingPlayer.isActive) {\n        throw new Error('You have been eliminated from the game.');\n    }\n    \n    if (!gameState.remainingCountries || !gameState.remainingCountries.some(c => c.id === chosenCountry.id)) {\n       console.error(\"Chosen country ID not found in remaining:\", chosenCountry?.id, gameState.remainingCountries);\n       throw new Error('Chosen country is not valid or not in the remaining inventory');\n    }\n\n    await update(gameStateRef, {\n      currentCountry: chosenCountry, \n      mode: 'placing', \n      lastUpdated: Date.now()\n    });\n  },\n  \n  // Helper to find the next active player\n  _findNextActivePlayer(players, currentPlayerId) {\n      const activePlayers = players.filter(p => p.isActive);\n      if (activePlayers.length === 0) return null; // Should not happen if checked before calling\n\n      const currentPlayerIndex = activePlayers.findIndex(p => p.id === currentPlayerId);\n      // If current player not found among active (e.g., just eliminated), or it's the last active player\n      if (currentPlayerIndex === -1 || currentPlayerIndex === activePlayers.length - 1) {\n          return activePlayers[0].id; // Wrap around to the first active player\n      } else {\n          return activePlayers[currentPlayerIndex + 1].id; // Next active player\n      }\n  },\n\n  // Player places the chosen card into the sorted list\n  async placeCard(lobbyId, playerId, placementIndex) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const snapshot = await get(gameStateRef);\n    let gameState = snapshot.val(); // Use 'let' as we might modify it locally before updating DB\n\n    if (!gameState || gameState.status !== 'playing') throw new Error('Game is not active or not found');\n    if (gameState.mode !== 'placing') throw new Error('Not in placing mode');\n    if (gameState.currentPlayer !== playerId) throw new Error('Not your turn to place');\n    if (!gameState.currentCountry) throw new Error('No country currently chosen for placement');\n    \n    // Ensure the player is active\n    const placingPlayer = gameState.players.find(p => p.id === playerId);\n    if (!placingPlayer || !placingPlayer.isActive) {\n        throw new Error('You have been eliminated from the game.');\n    }\n\n    if (typeof placementIndex !== 'number' || placementIndex < 0 || placementIndex > gameState.sortedCountries.length) {\n      console.error(\"Invalid placement index received:\", placementIndex, \"Current sorted length:\", gameState.sortedCountries.length);\n      throw new Error('Invalid placement index');\n    }\n    // Get the category from the game state\n    const category = gameState.category || 'population'; // Default to population if somehow missing\n\n    const potentialNewSortedCountries = [...gameState.sortedCountries];\n    potentialNewSortedCountries.splice(placementIndex, 0, gameState.currentCountry);\n\n    const isCorrect = (countriesList) => {\n      if (!Array.isArray(countriesList)) return false;\n      for (let i = 0; i < countriesList.length - 1; i++) {\n        if (!countriesList[i] || !countriesList[i+1] ||\n            typeof countriesList[i][category] === 'undefined' ||\n            typeof countriesList[i+1][category] === 'undefined' ||\n            countriesList[i][category] > countriesList[i + 1][category]) {\n          console.warn(`Incorrect order found at index ${i} for category ${category}:`, countriesList[i][category], countriesList[i+1][category]);\n          return false;\n        }\n      }\n      return true;\n    };\n    \n    let updates = {};\n    const players = gameState.players; // Get current player list\n    const placedCountryId = gameState.currentCountry.id;\n\n    if (isCorrect(potentialNewSortedCountries)) {\n      // Correct Placement\n      console.log(`Correct placement by ${playerId}.`);\n      \n      // Remove placed card from remaining\n      const updatedRemainingCountries = (gameState.remainingCountries || []).filter(country => country.id !== placedCountryId);\n\n      // Update score for the player who placed correctly\n      const playerIndex = players.findIndex(p => p.id === playerId);\n      if(playerIndex !== -1) {\n          players[playerIndex].score = (players[playerIndex].score || 0) + 1;\n      }\n\n      // Find the next active player\n      const nextPlayerId = this._findNextActivePlayer(players, playerId);\n      \n      updates = {\n        players: players, // Updated scores\n        currentPlayer: nextPlayerId,\n        sortedCountries: potentialNewSortedCountries,\n        remainingCountries: updatedRemainingCountries,\n        currentCountry: null,\n        mode: 'choosing',\n        lastUpdated: Date.now()\n      };\n\n      // Check if inventory is empty (Alternative win condition? Or just continue eliminating?)\n      // For Battle Royale, the game continues until one player is left, regardless of inventory.\n      // So, we don't end the game here based on empty inventory.\n\n    } else {\n      // Incorrect Placement - Eliminate Player\n      console.log(`Incorrect placement by ${playerId}. Eliminating player.`);\n      \n      const playerIndex = players.findIndex(p => p.id === playerId);\n      if (playerIndex !== -1) {\n          players[playerIndex].isActive = false;\n      }\n      \n      const activePlayers = players.filter(p => p.isActive);\n      const activePlayerIds = activePlayers.map(p => p.id);\n\n      if (activePlayers.length <= 1) {\n        // Game Over - Last player standing wins (or draw if 0 left somehow)\n        console.log(\"Battle Royale finished. Winner determined.\");\n        updates = {\n          players: players, // Show final status\n          activePlayers: activePlayerIds,\n          status: 'completed',\n          mode: 'finished',\n          result: activePlayers.length === 1 ? activePlayers[0].id : 'draw', // Store winner ID or 'draw'\n          winner: activePlayers.length === 1 ? activePlayers[0] : null, // Store full winner object\n          currentCountry: null, // Clear any chosen country\n          lastUpdated: Date.now()\n        };\n      } else {\n        // Game Continues - Find next active player\n        const nextPlayerId = this._findNextActivePlayer(players, playerId); // Find next player *after* elimination\n        \n        // Incorrectly placed card is discarded, player doesn't get another turn immediately.\n        // Remove the incorrectly placed card from the remaining inventory.\n        const updatedRemainingCountries = (gameState.remainingCountries || []).filter(country => country.id !== placedCountryId);\n\n        updates = {\n          players: players, // Updated player statuses\n          activePlayers: activePlayerIds,\n          currentPlayer: nextPlayerId,\n          currentCountry: null, // Clear the incorrectly placed country\n          remainingCountries: updatedRemainingCountries, // Remove the card\n          mode: 'choosing', // Next player starts by choosing\n          lastUpdated: Date.now()\n        };\n      }\n    }\n\n    await update(gameStateRef, updates);\n  },\n\n  // End game (Handles win condition based on elimination)\n  // This might not be explicitly called anymore, as placeCard handles the logic.\n  // Kept for potential manual ending or cleanup.\n  async endGame(lobbyId, winnerId = null) { \n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    const snapshot = await get(gameStateRef);\n    if (snapshot.exists()) {\n       const gameState = snapshot.val();\n       if (gameState.status === 'playing') {\n           const winner = gameState.players.find(p => p.id === winnerId);\n           await update(gameStateRef, {\n               status: 'completed',\n               result: winnerId || 'ended', // Store winner ID or generic 'ended'\n               winner: winner || null,\n               mode: 'finished',\n               currentCountry: null, \n               lastUpdated: Date.now()\n           });\n           console.log(`Battle Royale game ended. Winner: ${winnerId || 'N/A'}`);\n       } else {\n           console.log(\"Game already completed, skipping endGame call.\");\n       }\n    } else {\n       console.log(\"Game state not found, cannot end game for lobby:\", lobbyId);\n    }\n  },\n\n  // Clean up game state (Likely reusable)\n  async cleanupGameState(lobbyId) {\n    const gameStateRef = ref(realtimeDb, `${GAME_STATES_PATH}/${lobbyId}`);\n    await set(gameStateRef, null);\n    console.log(\"Cleaned up Battle Royale game state for lobby:\", lobbyId);\n  }\n}; ","import React, { useState, useEffect } from 'react';\r\nimport CountryCard from '../CountryCard'; // Adjusted path\r\nimport '../../pages/GamePage.css'; // Adjusted path\r\nimport { useNavigate } from 'react-router-dom'; // Removed useLocation\r\nimport { useAuth } from '../../contexts/AuthContext'; // Adjusted path\r\nimport { battleRoyaleGameService } from '../../services/battleRoyaleGameService'; // Adjusted path\r\n\r\n// Helper function to capitalize\r\nconst capitalize = (s) => s && s[0].toUpperCase() + s.slice(1);\r\n\r\n// Renamed component, accepts lobbyId and category as props\r\nfunction BattleRoyaleMode({ lobbyId, category: categoryProp = 'population' }) {\r\n  const { currentUser } = useAuth();\r\n  const [sortedCountries, setSortedCountries] = useState([]);\r\n  const [currentCountry, setCurrentCountry] = useState(null);\r\n  const [remainingCountries, setRemainingCountries] = useState([]);\r\n  const [gameState, setGameState] = useState('waiting'); // waiting, playing, completed\r\n  const [gameStateData, setGameStateData] = useState(null); // Store full game state\r\n  const navigate = useNavigate();\r\n  // Removed location logic\r\n\r\n  // Determine category primarily from gameStateData once loaded, fallback to prop\r\n  const category = gameStateData?.category || categoryProp;\r\n\r\n  useEffect(() => {\r\n    // Validate lobbyId passed as prop\r\n    if (!lobbyId) {\r\n      console.error(\"BattleRoyaleMode requires a lobbyId prop.\");\r\n      navigate('/'); \r\n      return;\r\n    }\r\n\r\n    // Subscribe to the game state using the Battle Royale service\r\n    const unsubscribe = battleRoyaleGameService.subscribeToGameState(lobbyId, (data) => {\r\n      if (data) {\r\n        setGameStateData(data);\r\n        setSortedCountries(data.sortedCountries || []);\r\n        setCurrentCountry(data.currentCountry || null);\r\n        setRemainingCountries(data.remainingCountries || []);\r\n        setGameState(data.status || 'waiting');\r\n        const currentCategory = data.category || 'population'; // Get category from data\r\n\r\n        // Handle game completion for Battle Royale\r\n        if (data.status === 'completed') {\r\n           let message = 'Battle Royale Over!';\r\n           let winnerName = 'N/A';\r\n           let winnerScore = 0;\r\n\r\n           if (data.winner) { // Check if there is a winner object\r\n               winnerName = data.winner.name;\r\n               winnerScore = data.winner.score || 0;\r\n               message = `${winnerName} is the last one standing!`;\r\n           } else if (data.result === 'draw') {\r\n               message = 'The Battle Royale ended in a draw!';\r\n           }\r\n\r\n           navigate('/gameover', { \r\n              state: { \r\n                score: winnerScore, \r\n                message: message,\r\n                winnerName: winnerName, \r\n                category: currentCategory, \r\n                gameMode: `battleRoyale_${currentCategory}`, \r\n                finalPlayersState: data.players \r\n              }, \r\n              replace: true \r\n            });\r\n        }\r\n      } else {\r\n        console.error(\"Game state not found for lobby:\", lobbyId);\r\n        navigate('/'); \r\n      }\r\n    });\r\n\r\n    return () => unsubscribe();\r\n\r\n  }, [lobbyId, navigate]); // Dependency is now lobbyId\r\n\r\n  // Handler for choosing a card \r\n  const handleChooseCard = async (country) => {\r\n    if (!gameStateData || !currentUser) return;\r\n    if (gameStateData.currentPlayer !== currentUser.uid) return; \r\n    if (gameStateData.mode !== 'choosing') return; \r\n    \r\n    const me = gameStateData.players.find(p => p.id === currentUser.uid);\r\n    if (!me || !me.isActive) {\r\n        console.log(\"Cannot choose card, you are eliminated.\");\r\n        return; \r\n    }\r\n\r\n    try {\r\n      await battleRoyaleGameService.chooseCard(gameStateData.lobbyId, currentUser.uid, country);\r\n    } catch (error) {\r\n      console.error(\"Error choosing card:\", error);\r\n    }\r\n  };\r\n\r\n  // Handler for placing a card \r\n  const handlePlaceCard = async (index) => {\r\n    if (!gameStateData || !currentUser || !currentCountry) return;\r\n    if (gameStateData.currentPlayer !== currentUser.uid) return; \r\n    if (gameStateData.mode !== 'placing') return; \r\n\r\n    const me = gameStateData.players.find(p => p.id === currentUser.uid);\r\n    if (!me || !me.isActive) {\r\n        console.log(\"Cannot place card, you are eliminated.\");\r\n        return; \r\n    }\r\n\r\n    try {\r\n      await battleRoyaleGameService.placeCard(gameStateData.lobbyId, currentUser.uid, index);\r\n    } catch (error) {\r\n      console.error(\"Error placing card:\", error);\r\n    }\r\n  };\r\n\r\n  if (!gameStateData || gameState === 'waiting') {\r\n    return <div className=\"game-mode-loading\">Loading Battle Royale...</div>;\r\n  }\r\n\r\n  const myPlayerState = gameStateData.players?.find(p => p.id === currentUser?.uid);\r\n  const isMyTurn = gameStateData.currentPlayer === currentUser?.uid && myPlayerState?.isActive;\r\n  const amIActive = myPlayerState?.isActive;\r\n  \r\n  const currentPlayer = gameStateData.players?.find(p => p.id === gameStateData.currentPlayer);\r\n  const currentPlayerName = currentPlayer?.name || 'Unknown';\r\n  \r\n  const canChoose = gameStateData.mode === 'choosing' && isMyTurn;\r\n  const canPlace = gameStateData.mode === 'placing' && isMyTurn && currentCountry;\r\n\r\n  return (\r\n    <div className={`game-mode battle-royale-mode ${!amIActive ? 'eliminated' : ''}`}> {/* Added base class */}\r\n      <h2>Battle Royale - {category === 'gini' ? 'Gini Index' : capitalize(category)}</h2>\r\n      {/* Player status */}\r\n      <div className=\"player-status-container\">\r\n        <h3>Players:</h3>\r\n        <ul>\r\n          {gameStateData.players?.map(p => (\r\n            <li key={p.id} className={`${!p.isActive ? 'eliminated-player' : ''} ${p.id === gameStateData.currentPlayer ? 'current-turn' : ''}`}>\r\n              {p.name} {p.id === currentUser?.uid ? '(You)' : ''} - Score: {p.score || 0} {!p.isActive ? '(Eliminated)' : ''}\r\n            </li>\r\n          ))}\r\n        </ul>\r\n      </div>\r\n      \r\n      {!amIActive && <p className=\"eliminated-message\">You have been eliminated!</p>}\r\n      \r\n      <p>Current Turn: {currentPlayerName} {gameStateData.currentPlayer === currentUser?.uid ? '(Your Turn)' : ''}</p>\r\n\r\n      {/* Sorted Countries */}\r\n      <div className=\"sorted-countries-container\">\r\n        <h3>Sorted Countries: ({sortedCountries.length})</h3>\r\n        <div className=\"sorted-countries\">\r\n          {canPlace && (\r\n            <button\r\n              className=\"place-button plus-button\"\r\n              onClick={() => handlePlaceCard(0)}\r\n              aria-label=\"Place card at the beginning\"\r\n              disabled={!amIActive} \r\n            >\r\n              +\r\n            </button>\r\n          )}\r\n          {sortedCountries.map((country, index) => (\r\n            <React.Fragment key={`sorted-fragment-${country.id}`}>\r\n              <CountryCard\r\n                country={country}\r\n                mode={category}\r\n                statisticValue={country[category]}\r\n                isFlippable={true}\r\n                isClickable={false}\r\n              />\r\n              {canPlace && (\r\n                <button\r\n                  className=\"place-button plus-button\"\r\n                  onClick={() => handlePlaceCard(index + 1)}\r\n                  aria-label={`Place card after ${country.name}`}\r\n                  disabled={!amIActive} \r\n                >\r\n                  +\r\n                </button>\r\n              )}\r\n            </React.Fragment>\r\n          ))}\r\n          {sortedCountries.length === 0 && canPlace && (\r\n             <button\r\n                className=\"place-button plus-button\"\r\n                onClick={() => handlePlaceCard(0)}\r\n                aria-label=\"Place first card\"\r\n                disabled={!amIActive} \r\n             >\r\n               +\r\n             </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Remaining Countries (Inventory) */}\r\n      <div className=\"remaining-countries\">\r\n        <h3>Remaining Countries: ({remainingCountries.length})</h3>\r\n        <div className=\"remaining-countries-grid\">\r\n          {remainingCountries.map((country) => {\r\n            const isSelectedForPlacing = gameStateData.mode === 'placing' && currentCountry && country.id === currentCountry.id;\r\n            return (\r\n              <CountryCard\r\n                key={`remaining-${country.id}`}\r\n                country={country}\r\n                mode={category}\r\n                statisticValue={country[category]}\r\n                isFlippable={false}\r\n                isClickable={canChoose}\r\n                onClick={() => canChoose && handleChooseCard(country)}\r\n                customClassName={`${isSelectedForPlacing ? 'selected-for-placing' : ''} ${!amIActive ? 'disabled-card' : ''}`}\r\n              />\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Game Instructions */}\r\n      <div className=\"game-instructions\">\r\n        {amIActive && gameStateData.mode === 'choosing' && (\r\n          isMyTurn ? (\r\n            <p>Choose a country to place next.</p>\r\n          ) : (\r\n            <p>Waiting for {currentPlayerName} to choose...</p>\r\n          )\r\n        )}\r\n        {amIActive && gameStateData.mode === 'placing' && (\r\n          isMyTurn ? (\r\n            <p>Place {currentCountry?.name} in the correct position based on {category === 'gini' ? 'Gini index' : category}.</p>\r\n          ) : (\r\n            <p>Waiting for {currentPlayerName} to place {currentCountry?.name}...</p>\r\n          )\r\n        )}\r\n        {!amIActive && gameState !== 'completed' && (\r\n            <p>Waiting for the remaining players...</p>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default BattleRoyaleMode; ","// src/pages/GamePage.js\n\nimport React from 'react';\nimport { useParams, Navigate, useLocation } from 'react-router-dom';\nimport { DndProvider } from 'react-dnd';\nimport { HTML5Backend } from 'react-dnd-html5-backend';\nimport SEO from '../components/SEO';\n\n// Import the reusable game mode components\nimport ClassicMode from '../components/Game/ClassicMode';\nimport CooperationMode from '../components/Game/CooperationMode';\nimport BattleRoyaleMode from '../components/Game/BattleRoyaleMode';\nimport './GamePage.css'; // Assuming common styles\n\n// List of valid categories and modes\nconst VALID_CATEGORIES = ['population', 'area', 'gini'];\n// Mode names should match component names (lowercase)\nconst VALID_MODES = ['classic', 'cooperation', 'battleroyale'];\n\nfunction UnifiedGamePage() {\n  const { category, mode } = useParams();\n  const location = useLocation(); // Needed for Coop/BR lobbyId\n\n  // --- Validation ---\n  const isValidCategory = VALID_CATEGORIES.includes(category?.toLowerCase());\n  const isValidMode = VALID_MODES.includes(mode?.toLowerCase());\n\n  if (!isValidCategory || !isValidMode) {\n    console.error(`Invalid category (${category}) or mode (${mode}) accessed.`);\n    // Redirect to home page or show a 404 component\n    return <Navigate to=\"/\" replace />;\n  }\n\n  // Multiplayer modes require lobbyId from location state\n  const lobbyId = location.state?.lobbyId;\n  if ((mode === 'cooperation' || mode === 'battleroyale') && !lobbyId) {\n    console.error(`${mode} mode requires a lobbyId in location state.`);\n    // Redirect or show an error message specific to needing a lobby\n    // Might redirect to a lobby page or home\n    return <Navigate to=\"/\" replace state={{ error: \"Lobby ID missing for multiplayer game.\" }} />;\n  }\n\n  // --- Component Rendering ---\n  const renderGameMode = () => {\n    switch (mode.toLowerCase()) {\n      case 'classic':\n        // Classic mode only needs the category\n        return <ClassicMode category={category} />;\n      case 'cooperation':\n        // Cooperation mode needs category and lobbyId\n        return <CooperationMode category={category} lobbyId={lobbyId} />;\n      case 'battleroyale':\n        // Battle Royale mode needs category and lobbyId\n        return <BattleRoyaleMode category={category} lobbyId={lobbyId} />;\n      default:\n        // This case should ideally be caught by validation, but acts as a fallback\n        console.error('Reached default case in renderGameMode - should not happen!');\n        return <Navigate to=\"/\" replace />;\n    }\n  };\n\n  return (\n    <div className=\"game-page-container\">\n      <SEO\n        title={`Sort by ${category.charAt(0).toUpperCase() + category.slice(1)} (${mode})`}\n        description={`Play Sortly: Sort countries by ${category} in ${mode} mode.`}\n      />\n      {/* This container can hold styles common to all game pages */}\n      <DndProvider backend={HTML5Backend}>\n        {renderGameMode()}\n      </DndProvider>\n    </div>\n  );\n}\n\nexport default UnifiedGamePage;\n\n\n","// src/api/leaderboardApi.js\n\n// Use localStorage for simplicity, replace with backend API calls in production\nconst LEADERBOARD_KEY_PREFIX = 'sortly_leaderboard_'; // Use a prefix for category-specific keys\n\n// Submit score for a specific category, optionally link to game history\nexport const submitScore = (playerName, score, category, gameHistoryId = null) => {\n  if (!category || typeof category !== 'string') {\n    console.error(\"Invalid category provided to submitScore:\", category);\n    return null;\n  }\n  const leaderboardKey = `${LEADERBOARD_KEY_PREFIX}${category.toLowerCase()}`;\n  const leaderboard = getLeaderboard(category); // Get the specific category leaderboard\n  const newEntry = {\n    id: Date.now(), // Simple ID, consider UUID in production\n    playerName,\n    score,\n    // Removed 'mode', using category-specific storage\n    date: new Date().toISOString(),\n    gameHistoryId: gameHistoryId, // Link to detailed game history entry ID if provided\n  };\n\n  leaderboard.push(newEntry);\n  // Sort by score (descending)\n  leaderboard.sort((a, b) => b.score - a.score);\n  // Keep only top N entries (e.g., top 100)\n  const topEntries = leaderboard.slice(0, 100);\n\n  try {\n      localStorage.setItem(leaderboardKey, JSON.stringify(topEntries));\n      console.log(`Score submitted to ${leaderboardKey}`, newEntry);\n      return newEntry;\n  } catch (error) {\n      console.error(`Error saving leaderboard to localStorage for ${category}:`, error);\n      // Handle potential storage limits or errors\n      return null;\n  }\n\n};\n\n// Get all entries for a specific category leaderboard\nexport const getLeaderboard = (category) => {\n  if (!category || typeof category !== 'string') {\n    console.error(\"Invalid category provided to getLeaderboard:\", category);\n    return [];\n  }\n  const leaderboardKey = `${LEADERBOARD_KEY_PREFIX}${category.toLowerCase()}`;\n  try {\n      const storedData = localStorage.getItem(leaderboardKey);\n      return JSON.parse(storedData || '[]');\n  } catch (error) {\n      console.error(`Error reading leaderboard from localStorage for ${category}:`, error);\n      return [];\n  }\n};\n\n// Get top N scores for a specific category\nexport const getTopScores = (category, limit = 5) => { // Default limit to 5\n  if (!category || typeof category !== 'string') {\n    console.error(\"Invalid category provided to getTopScores:\", category);\n    return [];\n  }\n  const leaderboard = getLeaderboard(category);\n  // Already sorted by getLeaderboard (or submitScore implicitly sorts)\n  return leaderboard.slice(0, limit);\n}; ","import { db } from '../firebase';\r\nimport { collection, query, where, orderBy, limit, getDocs, addDoc, serverTimestamp, doc, setDoc, getDoc } from 'firebase/firestore';\r\n\r\nconst ID_COUNTER_DOC = 'leaderboard_counters'; // Document to store simple incrementing IDs if needed, or just use Firestore IDs\r\nconst LEADERBOARD_COLLECTION = 'leaderboards';\r\n\r\nexport const leaderboardService = {\r\n  // Submit a score to the global leaderboard\r\n  async submitScore(playerName, score, category, gameHistoryId, userId = null) {\r\n    if (!category || typeof category !== 'string') {\r\n      console.error(\"Invalid category provided to submitScore:\", category);\r\n      return null;\r\n    }\r\n\r\n    // We can store one document per entry.\r\n    // To keep it clean, we might want to store it in a sub-collection per category, or a root collection with fields.\r\n    // Let's use a root collection 'leaderboard_entries' for simplicity and query/index it.\r\n\r\n    // Actually, to make \"Global Leaderboard\" efficient, we often just query 'gameHistory' if it has player names.\r\n    // But 'gameHistory' is huge. A dedicated 'leaderboard' collection is better.\r\n    // We will save every high score submission here.\r\n\r\n    try {\r\n      const entryData = {\r\n        playerName,\r\n        score,\r\n        category,\r\n        gameHistoryId,\r\n        userId, // Optional: link to auth user if signed in\r\n        timestamp: serverTimestamp()\r\n      };\r\n\r\n      // If we want to only keep ONE score per user per category (Max Score), we'd need to check first.\r\n      // For now, let's just append like the local one did, but let's be smart.\r\n      // Simple \"High Score\" tables usually take all entries.\r\n\r\n      const docRef = await addDoc(collection(db, LEADERBOARD_COLLECTION), entryData);\r\n      console.log(\"Global leaderboard score submitted:\", docRef.id);\r\n      return docRef.id;\r\n    } catch (error) {\r\n      console.error(\"Error submitting global score:\", error);\r\n      return null;\r\n    }\r\n  },\r\n\r\n  // Get top scores for a category\r\n  async getTopScores(category, limitCount = 100) {\r\n    if (!category) return [];\r\n\r\n    try {\r\n      const q = query(\r\n        collection(db, LEADERBOARD_COLLECTION),\r\n        where('category', '==', category),\r\n        orderBy('score', 'desc'),\r\n        limit(limitCount)\r\n      );\r\n\r\n      const snapshot = await getDocs(q);\r\n      return snapshot.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data()\r\n      }));\r\n    } catch (error) {\r\n      console.error(\"Error fetching global leaderboard:\", error);\r\n      // If index is missing, this will fail. We should catch it.\r\n      return [];\r\n    }\r\n  }\r\n};","import { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore';\nimport { db } from '../firebase';\n\nconst ACHIEVEMENTS_COLLECTION = 'achievements';\n\nconst ACHIEVEMENT_DEFINITIONS = {\n  population: {\n    sorting: {\n      bronze: { id: 'population_sorting_bronze', title: 'Population Bronze Sorter', description: 'Correctly sort 3 countries by population', icon: '', requirement: 3 },\n      silver: { id: 'population_sorting_silver', title: 'Population Silver Sorter', description: 'Correctly sort 7 countries by population', icon: '', requirement: 7 },\n      gold: { id: 'population_sorting_gold', title: 'Population Gold Sorter', description: 'Correctly sort 12 countries by population', icon: '', requirement: 12 },\n      platinum: { id: 'population_sorting_platinum', title: 'Population Platinum Sorter', description: 'Correctly sort 20 countries by population', icon: '', requirement: 20 }\n    },\n    gameCount: {\n      id: 'population_games',\n      title: 'Population Game Master',\n      description: 'Complete 50 population sorting games',\n      icon: '',\n      requirement: 50\n    }\n  },\n  area: {\n    sorting: {\n      bronze: { id: 'area_sorting_bronze', title: 'Area Bronze Sorter', description: 'Correctly sort 3 countries by area', icon: '', requirement: 3 },\n      silver: { id: 'area_sorting_silver', title: 'Area Silver Sorter', description: 'Correctly sort 7 countries by area', icon: '', requirement: 7 },\n      gold: { id: 'area_sorting_gold', title: 'Area Gold Sorter', description: 'Correctly sort 12 countries by area', icon: '', requirement: 12 },\n      platinum: { id: 'area_sorting_platinum', title: 'Area Platinum Sorter', description: 'Correctly sort 20 countries by area', icon: '', requirement: 20 }\n    },\n    gameCount: {\n      id: 'area_games',\n      title: 'Area Game Master',\n      description: 'Complete 50 area sorting games',\n      icon: '',\n      requirement: 50\n    }\n  },\n  gini: {\n    sorting: {\n      bronze: { id: 'gini_sorting_bronze', title: 'Gini Bronze Sorter', description: 'Correctly sort 3 countries by Gini index', icon: '', requirement: 3 },\n      silver: { id: 'gini_sorting_silver', title: 'Gini Silver Sorter', description: 'Correctly sort 7 countries by Gini index', icon: '', requirement: 7 },\n      gold: { id: 'gini_sorting_gold', title: 'Gini Gold Sorter', description: 'Correctly sort 12 countries by Gini index', icon: '', requirement: 12 },\n      platinum: { id: 'gini_sorting_platinum', title: 'Gini Platinum Sorter', description: 'Correctly sort 20 countries by Gini index', icon: '', requirement: 20 }\n    },\n    gameCount: {\n      id: 'gini_games',\n      title: 'Gini Game Master',\n      description: 'Complete 50 Gini sorting games',\n      icon: '',\n      requirement: 50\n    }\n  }\n};\n\nexport const achievementsService = {\n  // Get user achievements\n  async getUserAchievements(userId) {\n    try {\n      const userDoc = await getDoc(doc(db, ACHIEVEMENTS_COLLECTION, userId));\n      return userDoc.exists() ? userDoc.data() : null;\n    } catch (error) {\n      console.error('Error getting user achievements:', error);\n      throw error;\n    }\n  },\n\n  // Update user achievements\n  async updateUserAchievements(userId, achievements) {\n    try {\n      await setDoc(doc(db, ACHIEVEMENTS_COLLECTION, userId), {\n        ...achievements,\n        updatedAt: serverTimestamp()\n      }, { merge: true });\n    } catch (error) {\n      console.error('Error updating user achievements:', error);\n      throw error;\n    }\n  },\n\n  // Check and update achievements based on game results\n  async checkAndUpdateAchievements(userId, category, correctCount) {\n    try {\n      const currentAchievements = await this.getUserAchievements(userId) || {};\n      const categoryAchievements = ACHIEVEMENT_DEFINITIONS[category];\n      let updated = false;\n\n      // Check sorting achievements\n      Object.values(categoryAchievements.sorting).forEach(achievement => {\n        if (!currentAchievements[achievement.id] && correctCount >= achievement.requirement) {\n          currentAchievements[achievement.id] = {\n            unlocked: true,\n            unlockedAt: serverTimestamp()\n          };\n          updated = true;\n        }\n      });\n\n      // Check game count achievements\n      const gameCountAchievement = categoryAchievements.gameCount;\n      const currentCount = (currentAchievements[gameCountAchievement.id]?.count || 0) + 1;\n      \n      if (currentCount >= gameCountAchievement.requirement && !currentAchievements[gameCountAchievement.id]?.unlocked) {\n        currentAchievements[gameCountAchievement.id] = {\n          unlocked: true,\n          unlockedAt: serverTimestamp(),\n          count: currentCount\n        };\n        updated = true;\n      } else {\n        currentAchievements[gameCountAchievement.id] = {\n          ...currentAchievements[gameCountAchievement.id],\n          count: currentCount\n        };\n        updated = true;\n      }\n\n      if (updated) {\n        await this.updateUserAchievements(userId, currentAchievements);\n      }\n\n      return currentAchievements;\n    } catch (error) {\n      console.error('Error checking achievements:', error);\n      throw error;\n    }\n  },\n\n  // Achievement definitions\n  getAchievementDefinitions() {\n    return ACHIEVEMENT_DEFINITIONS;\n  }\n}; ","import { db } from '../firebase';\nimport { collection, query, where, orderBy, limit as firestoreLimit, getDocs, addDoc, serverTimestamp, doc, getDoc } from 'firebase/firestore';\n\nconst GAME_HISTORY_COLLECTION = 'gameHistory';\nconst CATEGORIES = ['population', 'area', 'gini'];\n\nexport const gameHistoryService = {\n  async getTopGames(userId, category, mode = 'classic', limitCount = 5) {\n    try {\n      console.log(`Fetching top games for: userId=${userId}, category=${category}, mode=${mode}, limit=${limitCount}`);\n      const gamesRef = collection(db, GAME_HISTORY_COLLECTION);\n      const q = query(\n        gamesRef,\n        where('userId', '==', userId),\n        where('category', '==', category),\n        where('mode', '==', mode),\n        orderBy('score', 'desc'),\n        firestoreLimit(limitCount)\n      );\n\n      const querySnapshot = await getDocs(q);\n      const games = querySnapshot.docs.map(doc => ({\n        id: doc.id,\n        ...doc.data()\n      }));\n      console.log(\"Fetched games:\", games);\n      return games;\n    } catch (error) {\n      console.error(\"Error fetching top games, attempting fallback:\", error);\n      // Fallback might be less efficient and might not work if index is required\n      // Consider warning the user or simplifying the fallback\n      try {\n          const qFallback = query(\n            collection(db, GAME_HISTORY_COLLECTION),\n            where('userId', '==', userId),\n            where('category', '==', category),\n            where('mode', '==', mode)\n          );\n          const querySnapshotFallback = await getDocs(qFallback);\n          const gamesFallback = querySnapshotFallback.docs.map(doc => ({\n            id: doc.id,\n            ...doc.data()\n          }));\n          // Sort in memory and limit\n          const sortedGames = gamesFallback.sort((a, b) => b.score - a.score).slice(0, limitCount);\n          console.log(\"Fetched games (fallback):\", sortedGames);\n          return sortedGames;\n      } catch (fallbackError) {\n          console.error(\"Fallback fetch also failed:\", fallbackError);\n          throw fallbackError; // Re-throw the error after logging\n      }\n    }\n  },\n\n  async getAllTopGames(userId) {\n    try {\n      const topGames = {};\n      await Promise.all(\n        CATEGORIES.map(async category => {\n          topGames[category] = await this.getTopGames(userId, category);\n        })\n      );\n      return topGames;\n    } catch (error) {\n      console.error('Error fetching all top games:', error);\n      return {};\n    }\n  },\n\n  async getGameDetails(gameId) {\n    try {\n        const docRef = doc(db, GAME_HISTORY_COLLECTION, gameId);\n        const docSnap = await getDoc(docRef);\n\n        if (docSnap.exists()) {\n            console.log(\"Fetched game details for ID:\", gameId, docSnap.data());\n            return { id: docSnap.id, ...docSnap.data() };\n        } else {\n            console.log(\"No such game document!\", gameId);\n            return null; // Indicate game not found\n        }\n    } catch (error) {\n        console.error(\"Error getting game details:\", error);\n        throw error;\n    }\n  },\n\n  async saveGame(userId, category, mode, score, userAttemptList, correctlySortedList, incorrectCountry) {\n    try {\n      // Minimal payload for general game history (like user's attempt)\n      const minimalUserAttempt = userAttemptList\n        ? userAttemptList.map(({ id, name, flagUrl, ...rest }) => ({ // Include stat used for sorting\n            id,\n            name,\n            flagUrl,\n            value: rest[category] // Store the actual value used for sorting\n          }))\n        : null;\n\n      // Specific data for classic mode review\n       const minimalCorrectlySorted = mode === 'classic' && correctlySortedList\n        ? correctlySortedList.map(({ id, name, flagUrl, ...rest }) => ({ // Include stat\n            id,\n            name,\n            flagUrl,\n            value: rest[category]\n          }))\n        : null;\n\n       const minimalIncorrectCountry = mode === 'classic' && incorrectCountry\n        ? { // Include stat\n            id: incorrectCountry.id,\n            name: incorrectCountry.name,\n            flagUrl: incorrectCountry.flagUrl,\n            value: incorrectCountry[category]\n          }\n        : null;\n\n      const docData = {\n        userId,\n        category,\n        mode, // Save the game mode ('classic', 'cooperation', etc.)\n        score,\n        userAttemptList: minimalUserAttempt, // List user provided (includes incorrect item)\n        correctlySortedList: minimalCorrectlySorted, // List before the mistake (classic only)\n        incorrectCountry: minimalIncorrectCountry, // The country placed incorrectly (classic only)\n        timestamp: serverTimestamp()\n      };\n\n      // Remove null fields before saving to Firestore if desired\n      Object.keys(docData).forEach(key => {\n          if (docData[key] === null) {\n              delete docData[key];\n          }\n      });\n\n      const docRef = await addDoc(collection(db, GAME_HISTORY_COLLECTION), docData);\n      console.log(\"Game history saved with ID:\", docRef.id, \"Data:\", docData);\n      return docRef.id;\n    } catch (error) {\n      console.error('Error saving game history:', error);\n      throw error;\n    }\n  }\n}; ","// src/pages/GameOverPage.js\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport CountryCard from '../components/CountryCard';\nimport { submitScore as submitScoreLocal } from '../api/leaderboardApi'; // Renaming local just in case we need fallback\nimport { leaderboardService } from '../services/leaderboardService';\nimport { achievementsService } from '../services/achievementsService';\nimport { gameHistoryService } from '../services/gameHistoryService';\nimport { userProfileService } from '../services/userProfileService';\nimport { useAuth } from '../contexts/AuthContext';\nimport { capitalize } from '../utils/stringUtils'; // Corrected import path\nimport './GameOverPage.css';\nimport '../components/Buttons.css';\n\n// Helper function to parse category and mode\nconst parseGameMode = (modeString) => {\n  if (!modeString || typeof modeString !== 'string') return { mode: 'unknown', category: 'unknown' };\n  const parts = modeString.split('_');\n  if (parts.length === 2) {\n    // Handle potential mode name changes if needed (e.g., battleRoyale)\n    const mode = parts[0].toLowerCase();\n    const category = parts[1].toLowerCase();\n    return { mode, category };\n  } else if (parts.length === 1) {\n    // Fallback for older/simpler modes if necessary?\n    return { mode: parts[0].toLowerCase(), category: 'unknown' }; // Or maybe default to population?\n  }\n  return { mode: 'unknown', category: 'unknown' };\n};\n\nfunction GameOverPage() {\n  const location = useLocation();\n  const navigate = useNavigate();\n  const { currentUser } = useAuth();\n\n  const {\n    score = 0,\n    message = 'Game Over!',\n    gameMode: gameModeString = 'unknown', // Get the combined string\n    // Classic mode specific:\n    incorrectCountry,\n    userOrder,\n    finalSortedList, // The correctly sorted list *before* the mistake\n    // Battle Royale specific:\n    winnerName,\n    finalPlayersState\n  } = location.state || {};\n\n  // Parse the mode and category from the combined string\n  const { mode, category } = parseGameMode(gameModeString);\n\n  const [playerName, setPlayerName] = useState('');\n  const [isSubmitted, setIsSubmitted] = useState(false);\n  const [error, setError] = useState('');\n  const [savedGameId, setSavedGameId] = useState(null); // Store the ID from gameHistoryService\n  const hasAttemptedSave = useRef(false); // Track if save attempt was made\n\n  // Fetch user profile for potential nickname\n  useEffect(() => {\n    const fetchUserProfile = async () => {\n      if (currentUser) {\n        try {\n          const profile = await userProfileService.getUserProfile(currentUser.uid);\n          if (profile?.nickname) {\n            setPlayerName(profile.nickname);\n          }\n        } catch (err) {\n          console.error('Error fetching user profile:', err);\n        }\n      }\n    };\n    fetchUserProfile();\n  }, [currentUser]);\n\n  // Save game history automatically when the component mounts and data is available\n  useEffect(() => {\n    const saveGameHistoryAndCheckAchievements = async () => {\n      // Only run if data is present and category/mode are known\n      if (hasAttemptedSave.current || category === 'unknown' || mode === 'unknown') {\n        if (hasAttemptedSave.current) console.log(\"Save skipped: Already attempted.\");\n        if (category === 'unknown' || mode === 'unknown') console.log(\"Save skipped: Unknown category or mode.\");\n        return;\n      }\n\n      hasAttemptedSave.current = true; // Mark as attempted regardless of login status\n\n      if (!currentUser) {\n        console.log(\"Firestore save skipped: No user logged in.\");\n        return;\n      }\n\n      console.log(\"Attempting to save game history...\");\n\n      let historyScore = 0;\n      let historyDataPayload = null; // For the user's attempt list or BR state\n      let correctlySortedForSave = null; // For classic mode: the list before mistake\n      let incorrectCountryForSave = null; // For classic mode: the wrongly placed country\n\n      if (mode === 'classic' || mode === 'cooperation') {\n        historyScore = score > 0 ? score - 1 : 0;\n        // User's final order (payload)\n        if (userOrder) {\n          historyDataPayload = userOrder.map(country => ({\n            id: country.id,\n            name: country.name,\n            flagUrl: country.flagUrl,\n            [category]: country[category]\n          }));\n        }\n        // Classic specific data\n        if (mode === 'classic') {\n          if (finalSortedList) { // Use finalSortedList passed from ClassicMode\n            correctlySortedForSave = finalSortedList.map(c => ({\n              id: c.id, name: c.name, flagUrl: c.flagUrl, [category]: c[category]\n            }));\n          }\n          if (incorrectCountry) {\n            incorrectCountryForSave = {\n              id: incorrectCountry.id,\n              name: incorrectCountry.name,\n              flagUrl: incorrectCountry.flagUrl,\n              [category]: incorrectCountry[category]\n            };\n          }\n        }\n      } else if (mode === 'battleroyale') {\n        historyScore = score;\n        if (finalPlayersState) {\n          historyDataPayload = finalPlayersState.map(p => ({\n            name: p.name, score: p.score, isActive: p.isActive\n          }));\n        }\n      } else {\n        console.log(\"Save skipped: Unrecognized game mode:\", mode);\n        return; // Don't save if mode isn't recognized\n      }\n\n      // Save only if ... (allow 0 score to be saved if we have payload)\n      if (historyScore >= 0 || (historyDataPayload && historyDataPayload.length > 0)) { // Changed > 0 to >= 0\n        try {\n          console.log('Calling gameHistoryService.saveGame with:', { userId: currentUser.uid, category, mode, historyScore });\n          const gameId = await gameHistoryService.saveGame(\n            currentUser.uid,\n            category,\n            mode,\n            historyScore,\n            historyDataPayload, // Pass the user's attempt list or BR state\n            correctlySortedForSave, // Pass classic mode's correct list (before mistake)\n            incorrectCountryForSave // Pass classic mode's incorrect country\n          );\n          setSavedGameId(gameId); // Store the returned ID\n          console.log('Game history saved successfully with ID:', gameId);\n\n          // Check Achievements (Classic Mode only)\n          if (mode === 'classic' && historyScore > 0) {\n            try {\n              await achievementsService.checkAndUpdateAchievements(currentUser.uid, category, historyScore);\n              console.log('Achievements checked successfully');\n            } catch (achievementErr) {\n              console.error('Error updating achievements:', achievementErr);\n            }\n          }\n\n        } catch (err) {\n          console.error('Error saving game history:', err);\n          setError('Failed to save game details. Score submission may not link correctly.');\n          // Still allow score submission, just won't be linked\n        }\n      } else {\n        console.log('Skipping game history save: Score is zero and no other data to save.');\n      }\n    };\n\n    saveGameHistoryAndCheckAchievements();\n    // Dependencies: Ensure all relevant state pieces trigger this effect appropriately.\n  }, [currentUser, mode, category, score, userOrder, finalSortedList, incorrectCountry, finalPlayersState]);\n\n\n\n  // Handle score submission\n  const handleSubmit = async (e) => { // Made async\n    e.preventDefault();\n    if (!playerName.trim()) {\n      setError('Please enter your name');\n      return;\n    }\n\n    let submitScoreValue = 0;\n    if (mode === 'classic' || mode === 'cooperation') {\n      submitScoreValue = score > 0 ? score - 1 : 0;\n    } else if (mode === 'battleroyale') {\n      submitScoreValue = score;\n    }\n\n    if (submitScoreValue < 0) { // Changed <= 0 to < 0 to allow 0 score\n      setError('Only scores of 0 or greater can be submitted.');\n      return;\n    }\n    if (category === 'unknown') {\n      setError('Cannot submit score for unknown category.');\n      return;\n    }\n\n    try {\n      // Pass category and the savedGameId (if available) to submitScore API\n      console.log(`Submitting score to Global Leaderboard: ${playerName}, ${submitScoreValue}, ${category}, History ID: ${savedGameId}`);\n\n      // Use GLOBAL Leaderboard Service\n      const submissionId = await leaderboardService.submitScore(\n        playerName,\n        submitScoreValue,\n        category,\n        savedGameId,\n        currentUser ? currentUser.uid : null\n      );\n\n      if (submissionId) {\n        setIsSubmitted(true);\n        setError('');\n      } else {\n        setError('Failed to submit score. Please try again.');\n      }\n    } catch (err) {\n      console.error(\"Error during score submission:\", err);\n      setError('Failed to submit score. Please try again.');\n    }\n  };\n\n  // Function to determine the correct path for \"Play Again\"\n  const getPlayAgainPath = () => {\n    if (category === 'unknown' || mode === 'unknown') return '/';\n\n    // Use parsed mode and category to construct path\n    if (mode === 'classic') {\n      return `/game/${category}/classic`;\n    } else if (mode === 'cooperation') {\n      return `/game/${category}/cooperation`; // Link back to lobby\n    } else if (mode === 'battleroyale') {\n      return `/game/${category}/battleroyale`; // Link back to lobby\n    } else {\n      return '/';\n    }\n  };\n\n  // Determine score display text based on mode\n  const getScoreDisplay = () => {\n    // Use parsed mode\n    if (mode === 'classic' || mode === 'cooperation') {\n      return `Your final score: ${score > 0 ? score - 1 : 0}`;\n    } else if (mode === 'battleroyale') {\n      return winnerName ? `${winnerName}'s winning score: ${score}` : `Final Score: ${score}`;\n    } else {\n      return `Final Score: ${score}`;\n    }\n  };\n\n  return (\n    <div className={`game-over-page game-over-${mode}-${category}`}> {/* Add mode and category class */}\n      <h2>Game Over</h2>\n      <p>{message}</p>\n      <p>{getScoreDisplay()}</p>\n\n      {/* Display final player standings for Battle Royale (uses parsed mode) */}\n      {mode === 'battleroyale' && finalPlayersState && (\n        <div className=\"final-player-standings\">\n          <h3>Final Standings:</h3>\n          <ul>\n            {finalPlayersState.sort((a, b) => (b.score || 0) - (a.score || 0)).map(player => (\n              <li key={player.id || player.name} className={!player.isActive ? 'eliminated-player' : ''}>\n                {player.name}: {player.score || 0} points {!player.isActive ? '(Eliminated)' : ''}\n              </li>\n            ))}\n          </ul>\n        </div>\n      )}\n\n      {/* Score Submission Form (uses parsed mode) */}\n      {!isSubmitted && (mode === 'classic' || mode === 'cooperation' || (mode === 'battleroyale' && score > 0)) && (\n        <form onSubmit={handleSubmit} className=\"score-submission\">\n          <div className=\"input-group\">\n            <label htmlFor=\"playerName\">Enter your name for Leaderboard:</label>\n            <input\n              type=\"text\"\n              id=\"playerName\"\n              value={playerName}\n              onChange={(e) => setPlayerName(e.target.value)}\n              placeholder=\"Your name\"\n              maxLength={20}\n              disabled={!currentUser} // Disable if not logged in?\n            />\n          </div>\n          {!currentUser && <p className=\"info-text\">Log in to save game details and submit scores!</p>}\n          {error && <p className=\"error\">{error}</p>}\n          <button type=\"submit\" className=\"button button-primary\" disabled={!playerName.trim() || !hasAttemptedSave.current}>\n            Submit Score\n          </button>\n        </form>\n      )}\n      {isSubmitted && (\n        <div className=\"submission-success\">\n          <p>Score submitted successfully!</p>\n        </div>\n      )}\n\n      {/* Display for Classic Mode incorrect placement (uses parsed mode/category) */}\n      {mode === 'classic' && userOrder && incorrectCountry && (\n        <div className=\"user-order\">\n          {/* This shows the order the user *attempted* including the wrong one */}\n          <h3>Your final attempt ({category === 'gini' ? 'Gini' : capitalize(category)}):</h3>\n          <div className=\"country-list\">\n            {userOrder.map((country) => (\n              <CountryCard\n                key={country.id}\n                country={country}\n                isClickable={false}\n                // Highlight the one they got wrong in their attempt\n                highlight={country.id === incorrectCountry.id ? 'incorrect' : ''}\n                mode={category} // Pass parsed category\n                statisticValue={country[category]} // Show stat\n                isFlippable={true} // Allow flipping to see stat\n              />\n            ))}\n          </div>\n        </div>\n      )}\n      {/* Show the correct order up until the mistake */}\n      {mode === 'classic' && finalSortedList && incorrectCountry && (\n        <div className=\"correct-order-display\">\n          {/* This shows the list *before* the mistake */}\n          <h3>Correctly sorted before mistake:</h3>\n          <div className=\"country-list\">\n            {finalSortedList.map((country) => (\n              <CountryCard\n                key={country.id}\n                country={country}\n                isClickable={false}\n                highlight={'correct'} // Mark all these as correct\n                mode={category} // Pass parsed category\n                statisticValue={country[category]} // Show stat\n                isFlippable={true}\n              />\n            ))}\n            {/* Optionally indicate where the incorrect one *should* have gone,\n                 or just show the incorrect one separately */}\n            <p style={{ textAlign: 'center', width: '100%', margin: '10px 0' }}>...then you incorrectly placed:</p>\n            <div className=\"country-list\" style={{ justifyContent: 'center' }}>\n              <CountryCard\n                key={incorrectCountry.id}\n                country={incorrectCountry}\n                isClickable={false}\n                highlight={'incorrect-standalone'} // Special highlight maybe?\n                mode={category}\n                statisticValue={incorrectCountry[category]}\n                isFlippable={true}\n              />\n            </div>\n          </div>\n        </div>\n      )}\n\n      <div className=\"navigation-buttons\">\n        <button\n          onClick={() => navigate(getPlayAgainPath())}\n          className=\"button button-secondary\"\n        >\n          Play Again\n        </button>\n        <button onClick={() => navigate('/')} className=\"button button-secondary\">\n          Go Home\n        </button>\n        <button onClick={() => navigate('/leaderboard')} className=\"button button-secondary\">\n          Leaderboard\n        </button>\n      </div>\n    </div>\n  );\n}\n\nexport default GameOverPage;\n","/**\r\n * Formats a timestamp or date string into a readable format (e.g., \"Oct 27, 2023\").\r\n * Handles both Firebase Timestamp objects and ISO date strings.\r\n * @param {object|string} dateInput - The Firebase Timestamp object or ISO date string.\r\n * @returns {string|null} The formatted date string, or null if input is invalid.\r\n */\r\nexport const formatDate = (dateInput) => {\r\n  try {\r\n    let dateObject = null;\r\n\r\n    // Check if it's likely a Firebase Timestamp (has toDate method)\r\n    if (dateInput && typeof dateInput.toDate === 'function') {\r\n      dateObject = dateInput.toDate();\r\n    }\r\n    // Check if it's a string (likely an ISO string from localStorage)\r\n    else if (typeof dateInput === 'string') {\r\n      dateObject = new Date(dateInput);\r\n      // Check if the parsed date is valid\r\n      if (isNaN(dateObject.getTime())) {\r\n          console.warn(\"formatDate received an invalid date string:\", dateInput);\r\n          return \"Invalid Date\";\r\n      }\r\n    }\r\n    // Check if it's already a Date object\r\n    else if (dateInput instanceof Date) {\r\n        dateObject = dateInput;\r\n    }\r\n\r\n    // If we couldn't create a valid Date object, return null or an indicator\r\n    if (!dateObject) {\r\n      console.warn(\"formatDate received an invalid input:\", dateInput);\r\n      return \"Unknown Date\"; // Or return null\r\n    }\r\n\r\n    // Format the valid Date object\r\n    return dateObject.toLocaleDateString('en-US', {\r\n      year: 'numeric',\r\n      month: 'short',\r\n      day: 'numeric'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(\"Error formatting date:\", dateInput, error);\r\n    return \"Date Error\"; // Indicate an error occurred during formatting\r\n  }\r\n}; ","import React, { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { getTopScores } from '../api/leaderboardApi'; // Using localStorage API for now\nimport { gameHistoryService } from '../services/gameHistoryService'; // Needed to fetch details\nimport SEO from '../components/SEO';\n// We'll use the history service later for clicking, but leaderboardApi for display\n// import { gameHistoryService } from '../services/gameHistoryService';\nimport { formatDate } from '../utils/dateUtils';\nimport { capitalize } from '../utils/stringUtils'; // Corrected import path\nimport './LeaderboardPage.css';\nimport '../components/CountryCard.css'; // Import for potential flag styling reuse\n\n// Define the classic categories\nconst CLASSIC_CATEGORIES = ['population', 'area', 'gini'];\n\nfunction LeaderboardPage() {\n  // State to hold leaderboards, including fetched details\n  const [leaderboards, setLeaderboards] = useState({});\n  const [loading, setLoading] = useState(true);\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    const loadLeaderboardsAndDetails = async () => {\n      setLoading(true);\n      const fetchedLeaderboards = {};\n      try {\n        for (const category of CLASSIC_CATEGORIES) {\n          // 1. Fetch top scores (basic info + gameHistoryId)\n          const topScores = getTopScores(category, 5);\n\n          // 2. Fetch details for each score that has a gameHistoryId\n          const enrichedScores = await Promise.all(\n            topScores.map(async (score) => {\n              if (score.gameHistoryId) {\n                try {\n                  const details = await gameHistoryService.getGameDetails(score.gameHistoryId);\n                  // Combine score with details (correctlySortedList, incorrectCountry)\n                  return { ...score, details: details || null };\n                } catch (err) {\n                  console.error(`Failed to fetch details for game ${score.gameHistoryId}:`, err);\n                  return { ...score, details: null }; // Keep score, mark details as failed\n                }\n              } else {\n                return { ...score, details: null }; // No ID, no details\n              }\n            })\n          );\n          fetchedLeaderboards[category] = enrichedScores;\n        }\n        console.log(\"Enriched Leaderboards:\", fetchedLeaderboards);\n        setLeaderboards(fetchedLeaderboards);\n      } catch (error) {\n        console.error(\"Error loading leaderboards:\", error);\n        // Handle error display if needed\n      } finally {\n        setLoading(false);\n      }\n    };\n    loadLeaderboardsAndDetails();\n  }, []); // Fetch only once on component mount\n\n  // --- Game History Clicking Logic (Placeholder/Future) ---\n  // To enable clicking, we'd need to:\n  // 1. Modify submitScore in leaderboardApi to optionally include the gameHistoryId\n  //    returned by gameHistoryService.saveGame.\n  // 2. Modify LeaderboardPage to fetch data possibly from Firestore (via a service)\n  //    which includes the gameHistoryId.\n  // 3. Implement the handleRowClick function.\n\n  const handleRowClick = (gameHistoryId) => {\n    if (gameHistoryId) {\n      console.log(\"Navigating to game review for ID:\", gameHistoryId);\n      navigate(`/game-review/${gameHistoryId}`); // Navigate to the new review page route\n    } else {\n      console.log(\"No game history ID associated with this leaderboard entry.\");\n      alert(\"Detailed game view not available for this entry (likely older data or not logged in when played).\");\n    }\n  };\n\n  const renderLeaderboardTable = (category, data) => {\n    const title = `Classic ${capitalize(category === 'gini' ? 'Gini Index' : category)}`;\n    return (\n      <div className=\"leaderboard-section\">\n        <h3>{title}</h3>\n        {data && data.length > 0 ? (\n          <div className=\"leaderboard-table\">\n            <table>\n              <thead>\n                <tr>\n                  <th>Rank</th>\n                  <th>Player</th>\n                  <th>Score</th>\n                  <th>Date</th>\n                  <th>Game Overview</th>\n                </tr>\n              </thead>\n              <tbody>\n                {data.map((entry, index) => (\n                  <tr\n                    key={entry.id || index}\n                    onClick={() => handleRowClick(entry.gameHistoryId)}\n                    className={entry.gameHistoryId ? 'clickable-row' : ''}\n                    title={entry.gameHistoryId ? 'Click to see game details' : 'Game details not available'}\n                  >\n                    <td>{index + 1}</td>\n                    <td>{entry.playerName}</td>\n                    <td>{entry.score}</td>\n                    <td>{formatDate(entry.date)}</td>\n                    <td className=\"leaderboard-flags\">\n                      {entry.details && entry.details.mode === 'classic' ? (\n                        <>\n                          {entry.details.correctlySortedList?.map(country => (\n                            <img\n                              key={`flag-correct-${country.id || country.name}`}\n                              src={country.flagUrl}\n                              alt={country.name}\n                              title={country.name}\n                              className=\"flag-image\"\n                            />\n                          ))}\n                          {entry.details.incorrectCountry && (\n                            <img\n                              key={`flag-incorrect-${entry.details.incorrectCountry.id || entry.details.incorrectCountry.name}`}\n                              src={entry.details.incorrectCountry.flagUrl}\n                              alt={`${entry.details.incorrectCountry.name} (Incorrect)`}\n                              title={`${entry.details.incorrectCountry.name} (Incorrect)`}\n                              className=\"flag-image incorrect-flag\"\n                            />\n                          )}\n                          <span role=\"img\" aria-label=\"View game details\" className=\"click-indicator\" title=\"Click for details\"></span>\n                        </>\n                      ) : entry.gameHistoryId ? (\n                        <span role=\"img\" aria-label=\"View game details\" className=\"click-indicator\" title=\"Click for details\"></span>\n                      ) : (\n                        <span>-</span>\n                      )}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        ) : (\n          <p>No entries yet for this category.</p>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"leaderboard-page\">\n      <SEO\n        title=\"Global Leaderboards\"\n        description=\"Check the top scores for Sortly. See who knows their geography best in population, area, and Gini index categories.\"\n      />\n      <h2>Classic Leaderboards</h2>\n      {loading ? (\n        <p>Loading leaderboards...</p>\n      ) : (\n        CLASSIC_CATEGORIES.map(category =>\n          renderLeaderboardTable(category, leaderboards[category])\n        )\n      )}\n      {/* Add navigation buttons if needed */}\n      <button onClick={() => navigate('/')} className=\"button button-secondary\" style={{ marginTop: '20px' }}>\n        Go Home\n      </button>\n    </div>\n  );\n}\n\nexport default LeaderboardPage; ","import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport './AvatarSelector.css';\r\n\r\nconst AvatarSelector = ({ avatarOptions, selectedAvatar, onSelect, onClose }) => (\r\n  <div className=\"avatar-selector\">\r\n    <div className=\"avatar-grid\">\r\n      {avatarOptions.map(avatar => (\r\n        <div \r\n          key={avatar.id} \r\n          className={`avatar-option ${selectedAvatar === avatar.url ? 'selected' : ''}`}\r\n          onClick={() => onSelect(avatar.url)}\r\n        >\r\n          <img src={avatar.url} alt={avatar.name} />\r\n          <span>{avatar.name}</span>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  </div>\r\n);\r\n\r\nAvatarSelector.propTypes = {\r\n  avatarOptions: PropTypes.arrayOf(PropTypes.shape({\r\n    id: PropTypes.string.isRequired,\r\n    url: PropTypes.string.isRequired,\r\n    name: PropTypes.string.isRequired\r\n  })).isRequired,\r\n  selectedAvatar: PropTypes.string.isRequired,\r\n  onSelect: PropTypes.func.isRequired,\r\n  onClose: PropTypes.func.isRequired\r\n};\r\n\r\nexport default AvatarSelector; ","import React, { useState } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport AvatarSelector from './AvatarSelector';\r\nimport './ProfileHeader.css';\r\n\r\nconst ProfileHeader = ({ \r\n  profile, \r\n  currentUser, \r\n  avatarOptions,\r\n  onSubmit\r\n}) => {\r\n  const [formData, setFormData] = useState({\r\n    nickname: profile?.nickname || '',\r\n    country: profile?.country || '',\r\n    avatarUrl: profile?.avatarUrl || avatarOptions[0].url\r\n  });\r\n  const [showAvatarSelector, setShowAvatarSelector] = useState(false);\r\n  const [isEditing, setIsEditing] = useState(false);\r\n\r\n  const handleChange = (e) => {\r\n    const { name, value } = e.target;\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [name]: value\r\n    }));\r\n    setIsEditing(true);\r\n  };\r\n\r\n  const handleAvatarSelect = (avatarUrl) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      avatarUrl\r\n    }));\r\n    setShowAvatarSelector(false);\r\n    setIsEditing(true);\r\n  };\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault();\r\n    try {\r\n      await onSubmit(formData);\r\n      setIsEditing(false);\r\n    } catch (error) {\r\n      console.error('Error saving profile:', error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"profile-header\">\r\n      <div className=\"avatar-container\">\r\n        <img \r\n          src={formData.avatarUrl} \r\n          alt=\"Profile\" \r\n          className=\"profile-avatar\"\r\n          onClick={() => setShowAvatarSelector(true)}\r\n        />\r\n        {showAvatarSelector && (\r\n          <AvatarSelector\r\n            avatarOptions={avatarOptions}\r\n            selectedAvatar={formData.avatarUrl}\r\n            onSelect={handleAvatarSelect}\r\n            onClose={() => setShowAvatarSelector(false)}\r\n          />\r\n        )}\r\n      </div>\r\n      <div className=\"profile-info\">\r\n        <form onSubmit={handleSubmit} className=\"profile-form\">\r\n          <div className=\"form-group\">\r\n            <input\r\n              type=\"text\"\r\n              name=\"nickname\"\r\n              value={formData.nickname}\r\n              onChange={handleChange}\r\n              placeholder=\"Set your nickname\"\r\n              className=\"inline-input\"\r\n            />\r\n          </div>\r\n          <div className=\"form-group\">\r\n            <input\r\n              type=\"text\"\r\n              name=\"country\"\r\n              value={formData.country}\r\n              onChange={handleChange}\r\n              placeholder=\"Set your country\"\r\n              className=\"inline-input\"\r\n            />\r\n          </div>\r\n          <div className=\"email-display\">{currentUser.email}</div>\r\n          {isEditing && (\r\n            <button type=\"submit\" className=\"save-button\">\r\n              Save Changes\r\n            </button>\r\n          )}\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nProfileHeader.propTypes = {\r\n  profile: PropTypes.shape({\r\n    nickname: PropTypes.string,\r\n    country: PropTypes.string,\r\n    avatarUrl: PropTypes.string\r\n  }),\r\n  currentUser: PropTypes.shape({\r\n    email: PropTypes.string.isRequired\r\n  }).isRequired,\r\n  avatarOptions: PropTypes.arrayOf(PropTypes.shape({\r\n    id: PropTypes.string.isRequired,\r\n    url: PropTypes.string.isRequired,\r\n    name: PropTypes.string.isRequired\r\n  })).isRequired,\r\n  onSubmit: PropTypes.func.isRequired\r\n};\r\n\r\nexport default ProfileHeader; ","import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { formatDate } from '../../utils/dateUtils';\r\nimport './AchievementCard.css';\r\n\r\nconst AchievementCard = ({ achievement, isUnlocked, unlockDate }) => (\r\n  <div className={`achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`}>\r\n    <div className=\"achievement-content\">\r\n      <div className=\"achievement-icon\">{achievement.icon}</div>\r\n      <div className=\"achievement-info\">\r\n        <h3>{achievement.title}</h3>\r\n        <p>{achievement.description}</p>\r\n        {isUnlocked && unlockDate && (\r\n          <div className=\"achievement-date\">\r\n            Unlocked: {formatDate(unlockDate)}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n    <div className=\"achievement-status\">\r\n      {isUnlocked ? '' : ''}\r\n    </div>\r\n  </div>\r\n);\r\n\r\nAchievementCard.propTypes = {\r\n  achievement: PropTypes.shape({\r\n    id: PropTypes.string.isRequired,\r\n    title: PropTypes.string.isRequired,\r\n    description: PropTypes.string.isRequired,\r\n    icon: PropTypes.string.isRequired\r\n  }).isRequired,\r\n  isUnlocked: PropTypes.bool.isRequired,\r\n  unlockDate: PropTypes.object\r\n};\r\n\r\nexport default AchievementCard; ","import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport AchievementCard from './AchievementCard';\r\nimport { transformAchievementDefinitions } from '../../utils/achievementUtils';\r\nimport './AchievementsSection.css';\r\n\r\nconst AchievementsSection = ({ achievementDefinitions, achievements }) => {\r\n  const transformedAchievements = transformAchievementDefinitions(achievementDefinitions);\r\n\r\n  return (\r\n    <div className=\"achievements-section\">\r\n      <h2>Achievements</h2>\r\n      <div className=\"achievements-grid\">\r\n        {transformedAchievements.map(achievement => (\r\n          <AchievementCard\r\n            key={achievement.id}\r\n            achievement={achievement}\r\n            isUnlocked={achievements?.[achievement.id]?.unlocked ?? false}\r\n            unlockDate={achievements?.[achievement.id]?.unlockedAt}\r\n          />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nAchievementsSection.propTypes = {\r\n  achievementDefinitions: PropTypes.object.isRequired,\r\n  achievements: PropTypes.objectOf(PropTypes.shape({\r\n    unlocked: PropTypes.bool,\r\n    unlockedAt: PropTypes.object\r\n  }))\r\n};\r\n\r\nexport default AchievementsSection; ","export const transformAchievementDefinitions = (definitions) => {\r\n  const achievements = [];\r\n  \r\n  // Process each category (population, area)\r\n  Object.entries(definitions).forEach(([category, categoryData]) => {\r\n    // Process sorting achievements\r\n    Object.entries(categoryData.sorting).forEach(([level, achievement]) => {\r\n      achievements.push({\r\n        ...achievement,\r\n        category,\r\n        type: 'sorting'\r\n      });\r\n    });\r\n    \r\n    // Process game count achievement\r\n    if (categoryData.gameCount) {\r\n      achievements.push({\r\n        ...categoryData.gameCount,\r\n        category,\r\n        type: 'gameCount'\r\n      });\r\n    }\r\n  });\r\n  \r\n  return achievements;\r\n}; ","import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { formatDate } from '../../utils/dateUtils';\r\nimport './GameHistoryItem.css';\r\n\r\nconst GameHistoryItem = ({ game, index, onClick }) => (\r\n  <div className=\"game-history-item\" onClick={() => onClick(game.id)}>\r\n    <div className=\"game-rank\">#{index + 1}</div>\r\n    <div className=\"game-score\">Score: {game.score}</div>\r\n    <div className=\"game-mode\">{game.category.charAt(0).toUpperCase() + game.category.slice(1)} Mode</div>\r\n    <div className=\"game-date\">\r\n      {game.timestamp?.toDate ? formatDate(game.timestamp) : 'Date unavailable'}\r\n    </div>\r\n    <div className=\"game-countries\">\r\n      {game.countries?.map((country, idx) => (\r\n        <div key={idx} className=\"country-item\">\r\n          <img src={country.flagUrl} alt={country.name} className=\"country-flag\" />\r\n          <span>{country.name}</span>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  </div>\r\n);\r\n\r\nGameHistoryItem.propTypes = {\r\n  game: PropTypes.shape({\r\n    id: PropTypes.string.isRequired,\r\n    score: PropTypes.number.isRequired,\r\n    category: PropTypes.string.isRequired,\r\n    timestamp: PropTypes.object,\r\n    countries: PropTypes.arrayOf(PropTypes.shape({\r\n      name: PropTypes.string.isRequired,\r\n      flagUrl: PropTypes.string.isRequired\r\n    }))\r\n  }).isRequired,\r\n  index: PropTypes.number.isRequired,\r\n  onClick: PropTypes.func.isRequired\r\n};\r\n\r\nexport default GameHistoryItem; ","import React, { useMemo } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport GameHistoryItem from './GameHistoryItem';\r\nimport './GameHistory.css';\r\n\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\nconst GameHistory = ({ gameHistory }) => {\r\n  const navigate = useNavigate();\r\n\r\n  const topGames = useMemo(() => {\r\n    if (!gameHistory || Object.keys(gameHistory).length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const entries = Object.entries(gameHistory);\r\n    const flattenedGames = entries.flatMap(([category, games]) =>\r\n      games.map(game => ({ ...game, category }))\r\n    );\r\n\r\n    const uniqueGames = flattenedGames.filter((game, index, self) =>\r\n      index === self.findIndex((g) => g.id === game.id)\r\n    );\r\n\r\n    return uniqueGames\r\n      .sort((a, b) => b.score - a.score)\r\n      .slice(0, 5);\r\n  }, [gameHistory]);\r\n\r\n  const handleGameClick = (gameId) => {\r\n    navigate(`/game-review/${gameId}`);\r\n  };\r\n\r\n  if (!gameHistory) {\r\n    return (\r\n      <div className=\"game-history-section\">\r\n        <h2>Best 5 Games</h2>\r\n        <p>Loading game history...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (Object.keys(gameHistory).length === 0) {\r\n    return (\r\n      <div className=\"game-history-section\">\r\n        <h2>Best 5 Games</h2>\r\n        <p>No games played yet. Start playing to see your best games here!</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"game-history-section\">\r\n      <h2>Best 5 Games</h2>\r\n      <div className=\"game-history-list\">\r\n        {topGames.map((game, index) => (\r\n          <GameHistoryItem\r\n            key={game.id}\r\n            game={game}\r\n            index={index}\r\n            onClick={handleGameClick}\r\n          />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nGameHistory.propTypes = {\r\n  gameHistory: PropTypes.objectOf(PropTypes.arrayOf(PropTypes.shape({\r\n    id: PropTypes.string.isRequired,\r\n    score: PropTypes.number.isRequired,\r\n    timestamp: PropTypes.object,\r\n    countries: PropTypes.arrayOf(PropTypes.shape({\r\n      name: PropTypes.string.isRequired,\r\n      flagUrl: PropTypes.string.isRequired\r\n    }))\r\n  })))\r\n};\r\n\r\nexport default GameHistory; ","import React, { useState, useEffect, useCallback } from 'react';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useNavigate } from 'react-router-dom';\nimport { userProfileService } from '../services/userProfileService';\nimport { achievementsService } from '../services/achievementsService';\nimport { avatarService } from '../services/avatarService';\nimport { gameHistoryService } from '../services/gameHistoryService';\nimport ProfileHeader from '../components/profile/ProfileHeader';\nimport AchievementsSection from '../components/profile/AchievementsSection';\nimport GameHistory from '../components/profile/GameHistory';\nimport './ProfilePage.css';\n\nconst ProfilePage = () => {\n  const { currentUser } = useAuth();\n  const navigate = useNavigate();\n  const [profile, setProfile] = useState(null);\n  const [achievements, setAchievements] = useState(null);\n  const [gameHistory, setGameHistory] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState('');\n  const [editing, setEditing] = useState(false);\n  const [showAvatarSelector, setShowAvatarSelector] = useState(false);\n  const [formData, setFormData] = useState({\n    nickname: '',\n    country: '',\n    avatarUrl: ''\n  });\n\n  const avatarOptions = avatarService.getAvatarOptions();\n  const achievementDefinitions = achievementsService.getAchievementDefinitions();\n  const userId = currentUser?.uid;\n\n  const loadProfile = useCallback(async () => {\n    if (!userId) return;\n\n    try {\n      const [userProfile, userAchievements, userGameHistory] = await Promise.all([\n        userProfileService.getUserProfile(userId),\n        achievementsService.getUserAchievements(userId),\n        gameHistoryService.getAllTopGames(userId)\n      ]);\n\n      if (userProfile) {\n        setProfile(userProfile);\n        setFormData({\n          nickname: userProfile.nickname || '',\n          country: userProfile.country || '',\n          avatarUrl: userProfile.avatarUrl || avatarOptions[0].url\n        });\n      }\n\n      setAchievements(userAchievements);\n      setGameHistory(userGameHistory);\n    } catch (error) {\n      setError('Failed to load profile: ' + error.message);\n    } finally {\n      setLoading(false);\n    }\n  }, [userId, avatarOptions]);\n\n  useEffect(() => {\n    if (currentUser) {\n      loadProfile();\n    }\n  }, [currentUser, loadProfile]);\n\n  const handleInputChange = (e) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({ ...prev, [name]: value }));\n  };\n\n  const handleAvatarSelect = (avatarUrl) => {\n    setFormData(prev => ({ ...prev, avatarUrl }));\n    setShowAvatarSelector(false);\n  };\n\n  const handleSubmit = async (data) => {\n    // e.preventDefault(); // Not needed as ProfileHeader handles the event\n    try {\n      setError('');\n      await userProfileService.updateUserProfile(currentUser.uid, data);\n      setProfile(prev => ({ ...prev, ...data }));\n      setEditing(false);\n    } catch (error) {\n      setError('Failed to update profile: ' + error.message);\n    }\n  };\n\n  if (!currentUser) {\n    navigate('/');\n    return null;\n  }\n\n  if (loading) {\n    return <div className=\"profile-page\">Loading...</div>;\n  }\n\n  return (\n    <div className=\"profile-page\">\n      <div className=\"profile-content\">\n        <ProfileHeader\n          profile={profile}\n          currentUser={currentUser}\n          editing={editing}\n          formData={formData}\n          avatarOptions={avatarOptions}\n          showAvatarSelector={showAvatarSelector}\n          onEdit={() => setEditing(true)}\n          onAvatarSelect={handleAvatarSelect}\n          onAvatarSelectorToggle={() => setShowAvatarSelector(!showAvatarSelector)}\n          onSubmit={handleSubmit}\n          onChange={handleInputChange}\n          onCancel={() => setEditing(false)}\n        />\n\n        {error && <div className=\"error-message\">{error}</div>}\n\n        <AchievementsSection\n          achievementDefinitions={achievementDefinitions}\n          achievements={achievements}\n        />\n\n        <GameHistory gameHistory={gameHistory} />\n      </div>\n    </div>\n  );\n};\n\nexport default ProfilePage; ","import { realtimeDb } from '../firebase';\nimport { ref, set, update, remove, get, onValue, off } from 'firebase/database';\n\nconst LOBBIES_PATH = 'lobbies';\n\nclass LobbyService {\n  constructor() {\n    this.lobbiesRef = ref(realtimeDb, LOBBIES_PATH);\n  }\n\n  // Create a new lobby\n  async createLobby(lobbyId, player, gameMode = 'cooperation') {\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    await set(lobbyRef, {\n      players: [player],\n      status: 'waiting',\n      gameMode: gameMode,\n      createdAt: Date.now(),\n      lastUpdated: Date.now()\n    });\n    return lobbyId;\n  }\n\n  // Join an existing lobby\n  async joinLobby(lobbyId, player) {\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    const snapshot = await get(lobbyRef);\n    const lobbyData = snapshot.val();\n    \n    if (lobbyData) {\n      const currentPlayers = lobbyData.players || [];\n      if (currentPlayers.some(p => p.id === player.id)) {\n        console.warn(`Player ${player.id} already in lobby ${lobbyId}.`);\n        return;\n      }\n      await update(lobbyRef, {\n        players: [...currentPlayers, player],\n        lastUpdated: Date.now()\n      });\n    } else {\n      throw new Error('Lobby not found');\n    }\n  }\n\n  // Leave a lobby\n  async leaveLobby(lobbyId, playerId) {\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    const snapshot = await get(lobbyRef);\n    const lobbyData = snapshot.val();\n    \n    if (lobbyData) {\n      const currentPlayers = lobbyData.players || [];\n      const updatedPlayers = currentPlayers.filter(p => p.id !== playerId);\n      \n      if (updatedPlayers.length === 0) {\n        console.log(`Last player left lobby ${lobbyId}. Deleting lobby.`);\n        await remove(lobbyRef);\n      } else {\n        let updates = {\n            players: updatedPlayers,\n            lastUpdated: Date.now()\n        };\n        \n        await update(lobbyRef, updates);\n      }\n    } else {\n      console.warn(`Attempted to leave non-existent or already deleted lobby: ${lobbyId}`);\n    }\n  }\n\n  // Subscribe to lobby changes\n  subscribeToLobby(lobbyId, callback) {\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    const listener = onValue(lobbyRef, (snapshot) => {\n      const data = snapshot.val();\n      callback(data);\n    }, (error) => {\n        console.error(`Error subscribing to lobby ${lobbyId}:`, error);\n        callback(null);\n    });\n\n    return () => off(lobbyRef, 'value', listener);\n  }\n\n  // Start the game\n  async startGame(lobbyId) {\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    await update(lobbyRef, {\n      status: 'playing',\n      startedAt: Date.now(),\n      lastUpdated: Date.now()\n    });\n  }\n\n  // End the game\n  async endGame(lobbyId, result = {}) {\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    await update(lobbyRef, {\n      status: 'completed',\n      result: result,\n      endedAt: Date.now(),\n      lastUpdated: Date.now()\n    });\n  }\n\n  // Clean up lobby\n  async cleanupLobby(lobbyId) {\n    console.log(`Cleaning up lobby: ${lobbyId}`);\n    const lobbyRef = ref(realtimeDb, `${LOBBIES_PATH}/${lobbyId}`);\n    await remove(lobbyRef);\n  }\n}\n\nexport const lobbyService = new LobbyService(); ","import React, { useState, useEffect, useRef } from 'react';\nimport { useNavigate, useSearchParams, useParams } from 'react-router-dom';\nimport { useAuth } from '../contexts/AuthContext';\nimport { userProfileService } from '../services/userProfileService';\nimport { lobbyService } from '../services/lobbyService';\nimport { cooperationGameService } from '../services/cooperationGameService';\nimport { battleRoyaleGameService } from '../services/battleRoyaleGameService';\nimport './GameLobby.css';\n\n// Define game settings based on mode (moved outside component)\nconst gameSettings = {\n  cooperation: {\n    minPlayers: 2,\n    maxPlayers: 4, // Assuming max 4 for cooperation\n    service: cooperationGameService,\n    name: 'Cooperation Mode'\n  },\n  battleRoyale: {\n    minPlayers: 2,\n    maxPlayers: 8,\n    service: battleRoyaleGameService,\n    name: 'Battle Royale Mode'\n  }\n};\n\nfunction GameLobby({ gameMode }) {\n  const { currentUser } = useAuth();\n  const { category } = useParams();\n  const [lobbyId, setLobbyId] = useState('');\n  const [players, setPlayers] = useState([]);\n  const [isHost, setIsHost] = useState(false);\n  const [error, setError] = useState('');\n  const [copyStatus, setCopyStatus] = useState('');\n  const navigate = useNavigate();\n  const [searchParams] = useSearchParams();\n  const currentLobbyId = useRef('');\n  const currentPlayer = useRef(null);\n\n  // Effect 2: Initialize lobby, join/create, and subscribe *after* gameMode prop is available\n  useEffect(() => {\n    // Wait for gameMode prop and user to be logged in\n    if (!gameMode || !currentUser || !category) {\n      if (!category) setError('Game category not specified in URL.');\n      return; \n    }\n\n    let unsubscribeFn = null;\n    let isMounted = true; // Flag to prevent state updates on unmounted component\n\n    const initializeLobby = async () => {\n      try {\n        let playerName = '';\n        try {\n          const profile = await userProfileService.getUserProfile(currentUser.uid);\n          playerName = profile?.nickname || '';\n        } catch (fetchProfileError) {\n          console.error('Error fetching user profile:', fetchProfileError);\n        }\n\n        const lobbyParam = searchParams.get('lobby');\n        let targetLobbyId = '';\n        let playerInfo = {\n          id: currentUser.uid,\n          name: playerName || (lobbyParam ? `Player ${Math.floor(Math.random() * 100)}` : 'Player 1'),\n          email: currentUser.email\n        };\n        currentPlayer.current = playerInfo;\n\n        if (lobbyParam) { // Join Lobby\n          targetLobbyId = lobbyParam;\n          currentLobbyId.current = targetLobbyId;\n          if (isMounted) {\n             setLobbyId(targetLobbyId);\n             setIsHost(false); \n          }\n          try {\n            await lobbyService.joinLobby(targetLobbyId, playerInfo);\n          } catch (joinError) {\n            console.error('Error joining lobby:', joinError);\n            if (isMounted) setError(joinError.message || 'Failed to join lobby');\n            return; \n          }\n        } else { // Create Lobby\n          targetLobbyId = Math.random().toString(36).substring(2, 8).toUpperCase();\n          currentLobbyId.current = targetLobbyId;\n          if (isMounted) {\n              setLobbyId(targetLobbyId);\n              setIsHost(true);\n          }\n          try {\n            await lobbyService.createLobby(targetLobbyId, playerInfo, gameMode, category); \n          } catch (createError) {\n            console.error('Error creating lobby:', createError);\n            if (isMounted) setError(createError.message || 'Failed to create lobby');\n            return; \n          }\n        }\n\n        // Subscribe to lobby changes\n        unsubscribeFn = lobbyService.subscribeToLobby(targetLobbyId, (lobbyData) => {\n          if (!isMounted) return; \n          \n          if (lobbyData) {\n            setPlayers(lobbyData.players || []);\n            setIsHost(lobbyData.players && lobbyData.players[0]?.id === currentUser.uid);\n            \n            const dbCategory = lobbyData.category;\n            if (dbCategory && dbCategory !== category) {\n                 console.warn(`Lobby category (${dbCategory}) doesn't match URL category (${category})`);\n            }\n\n            if (lobbyData.status === 'playing') {\n              if (gameMode && category) { \n                  const navigatePath = `/game/${category}/${gameMode}`; \n                  try {\n                    console.log(`Navigating to ${navigatePath} with mode ${gameMode} and category ${category}`);\n                    navigate(navigatePath, { \n                      state: { lobbyId: targetLobbyId } \n                    });\n                  } catch (navError) {\n                      console.error(\"Navigation error:\", navError);\n                  }\n              } else {\n                 console.error(\"Cannot navigate, gameMode prop or category param is missing.\");\n                 setError(\"Error determining game mode/category for navigation.\");\n              }\n            }\n          } else {\n            setError('Lobby not found or has been closed');\n          }\n        });\n      } catch (error) {\n        console.error('Error initializing lobby:', error);\n        if (isMounted) setError('Failed to initialize lobby');\n      }\n    };\n\n    initializeLobby();\n\n    // Cleanup function\n    return () => {\n      isMounted = false; \n      if (unsubscribeFn) {\n        unsubscribeFn();\n      }\n      if (currentLobbyId.current && currentPlayer.current) {\n        lobbyService.leaveLobby(currentLobbyId.current, currentPlayer.current.id);\n      }\n    };\n  }, [gameMode, searchParams, currentUser, navigate, category]); \n\n  const copyLink = async () => {\n    if (!gameMode || !currentLobbyId.current || !category) return;\n\n    const baseUrl = window.location.origin;\n    const gameLink = `${baseUrl}/#/game/${category}/${gameMode}?lobby=${encodeURIComponent(currentLobbyId.current)}`;\n    \n    try {\n      await navigator.clipboard.writeText(gameLink);\n      setCopyStatus('Copied!');\n      setTimeout(() => setCopyStatus(''), 2000);\n    } catch (err) {\n      const textArea = document.createElement('textarea');\n      textArea.value = gameLink;\n      textArea.style.position = 'fixed';\n      textArea.style.left = '-9999px';\n      document.body.appendChild(textArea);\n      textArea.focus();\n      textArea.select();\n      try {\n        document.execCommand('copy');\n        setCopyStatus('Copied!');\n        setTimeout(() => setCopyStatus(''), 2000);\n      } catch (copyErr) {\n        setCopyStatus('Failed to copy');\n        console.error('Fallback copy failed: ', copyErr);\n      }\n      document.body.removeChild(textArea);\n    }\n  };\n\n  const startGame = async () => {\n    if (!isHost || !gameMode || !currentLobbyId.current || !category) return;\n\n    const settings = gameSettings[gameMode];\n    if (!settings) {\n      setError('Invalid game mode configuration.');\n      return;\n    }\n    if (players.length < settings.minPlayers) {\n      setError(`Waiting for more players. Need at least ${settings.minPlayers}.`);\n      return;\n    }\n    if (players.length > settings.maxPlayers) {\n      setError(`Too many players. Maximum is ${settings.maxPlayers}.`);\n      return;\n    }\n\n    try {\n      setError('');\n      \n      await settings.service.initializeGameState(\n        currentLobbyId.current, \n        players,\n        category\n      );\n\n      await lobbyService.startGame(currentLobbyId.current);\n\n    } catch (error) {\n      console.error('Error starting game:', error);\n      setError(error.message || 'Failed to start game');\n    }\n  };\n  \n  if (!gameMode) {\n    return <div className=\"game-lobby\">Error: Game mode not provided.</div>;\n  }\n  if (!category) {\n      return <div className=\"game-lobby\">Error: Game category not specified in URL. {error && <p className=\"error-message\">{error}</p>}</div>;\n  }\n  if (!currentUser) {\n    return <div className=\"game-lobby\">Loading user...</div>;\n  }\n\n  const settings = gameSettings[gameMode];\n\n  return (\n    <div className=\"game-lobby\">\n      <div className=\"lobby-header\">\n        <h2>{settings?.name || 'Game Lobby'} - {category.toUpperCase()}</h2>\n        {lobbyId && <p className=\"lobby-id-display\">Lobby ID: <strong>{lobbyId}</strong></p>}\n      </div>\n      \n      {error && <p className=\"error-message\">{error}</p>}\n\n      <div className=\"player-list-container\">\n        <h3>Players ({players.length} / {settings?.maxPlayers || 'N/A'}):</h3>\n        <ul className=\"player-list\">\n          {players.map((player, index) => (\n            <li key={player.id} className=\"player-item\">\n              <span className=\"player-name\">{player.name || `Player ${index + 1}`}</span>\n              {player.id === currentUser.uid && <span className=\"player-tag you-tag\"> (You)</span>} \n              {index === 0 && <span className=\"player-tag host-tag\"> (Host)</span>}\n            </li>\n          ))}\n        </ul>\n      </div>\n\n      {lobbyId && (\n        <div className=\"lobby-controls\">\n          {isHost ? (\n            <>\n              <button \n                className=\"button button-secondary\" \n                onClick={copyLink} \n                disabled={copyStatus === 'Copied!' || copyStatus === 'Failed to copy'}\n              >\n                {copyStatus || 'Copy Invite Link'}\n              </button>\n              <button \n                className=\"button button-primary\" \n                onClick={startGame} \n                disabled={players.length < (settings?.minPlayers || 2)}\n              >\n                Start Game\n              </button>\n            </>\n          ) : (\n            <button \n              className=\"button button-secondary\" \n              onClick={copyLink} \n              disabled={copyStatus === 'Copied!' || copyStatus === 'Failed to copy'}\n            >\n              {copyStatus || 'Copy Invite Link'}\n            </button>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default GameLobby; ","import React, { useState } from 'react';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { leaderboardService } from '../services/leaderboardService';\r\n\r\nexport function FirebaseTest() {\r\n  const { currentUser, login, signup, logout } = useAuth();\r\n  const [email, setEmail] = useState('');\r\n  const [password, setPassword] = useState('');\r\n  const [error, setError] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [testScore, setTestScore] = useState(null);\r\n\r\n  async function handleSubmit(e) {\r\n    e.preventDefault();\r\n    try {\r\n      setError('');\r\n      setLoading(true);\r\n      await signup(email, password);\r\n    } catch (error) {\r\n      setError('Failed to create an account: ' + error.message);\r\n    }\r\n    setLoading(false);\r\n  }\r\n\r\n  async function handleLogin(e) {\r\n    e.preventDefault();\r\n    try {\r\n      setError('');\r\n      setLoading(true);\r\n      await login(email, password);\r\n    } catch (error) {\r\n      setError('Failed to log in: ' + error.message);\r\n    }\r\n    setLoading(false);\r\n  }\r\n\r\n  async function handleLogout() {\r\n    try {\r\n      setError('');\r\n      setLoading(true);\r\n      await logout();\r\n    } catch (error) {\r\n      setError('Failed to log out: ' + error.message);\r\n    }\r\n    setLoading(false);\r\n  }\r\n\r\n  async function addTestScore() {\r\n    if (!currentUser) return;\r\n    try {\r\n      await leaderboardService.addScore(\r\n        currentUser.uid,\r\n        currentUser.email,\r\n        100,\r\n        'test'\r\n      );\r\n      setTestScore('Score added successfully!');\r\n    } catch (error) {\r\n      setTestScore('Failed to add score: ' + error.message);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div style={{ padding: '20px' }}>\r\n      <h2>Firebase Test</h2>\r\n      \r\n      {currentUser ? (\r\n        <div>\r\n          <p>Logged in as: {currentUser.email}</p>\r\n          <button onClick={handleLogout} disabled={loading}>\r\n            Log Out\r\n          </button>\r\n          <button onClick={addTestScore} style={{ marginLeft: '10px' }}>\r\n            Add Test Score\r\n          </button>\r\n          {testScore && <p>{testScore}</p>}\r\n        </div>\r\n      ) : (\r\n        <div>\r\n          <form onSubmit={handleSubmit}>\r\n            <input\r\n              type=\"email\"\r\n              value={email}\r\n              onChange={(e) => setEmail(e.target.value)}\r\n              placeholder=\"Email\"\r\n              required\r\n            />\r\n            <input\r\n              type=\"password\"\r\n              value={password}\r\n              onChange={(e) => setPassword(e.target.value)}\r\n              placeholder=\"Password\"\r\n              required\r\n            />\r\n            <button type=\"submit\" disabled={loading}>\r\n              Sign Up\r\n            </button>\r\n          </form>\r\n          <form onSubmit={handleLogin} style={{ marginTop: '10px' }}>\r\n            <button type=\"submit\" disabled={loading}>\r\n              Log In\r\n            </button>\r\n          </form>\r\n        </div>\r\n      )}\r\n      \r\n      {error && <p style={{ color: 'red' }}>{error}</p>}\r\n    </div>\r\n  );\r\n} ","// src/pages/GameReviewPage.js\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useParams, useNavigate, Link } from 'react-router-dom';\r\nimport { gameHistoryService } from '../services/gameHistoryService';\r\nimport CountryCard from '../components/CountryCard';\r\nimport { formatDate } from '../utils/dateUtils';\r\nimport { capitalize } from '../utils/stringUtils';\r\nimport './GameReviewPage.css'; // Create this CSS file for styling\r\nimport '../components/Buttons.css';\r\n\r\nfunction GameReviewPage() {\r\n  const { gameId } = useParams();\r\n  const navigate = useNavigate();\r\n  const [gameData, setGameData] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n\r\n  useEffect(() => {\r\n    const fetchGameData = async () => {\r\n      if (!gameId) {\r\n        setError('No game ID provided.');\r\n        setLoading(false);\r\n        return;\r\n      }\r\n      setLoading(true);\r\n      try {\r\n        console.log(`Fetching game details for ID: ${gameId}`);\r\n        const data = await gameHistoryService.getGameDetails(gameId);\r\n        if (data) {\r\n          console.log(\"Fetched game data:\", data);\r\n          // Ensure nested arrays/objects exist before accessing\r\n          if (!data.correctlySortedList) data.correctlySortedList = [];\r\n          if (!data.incorrectCountry) data.incorrectCountry = null;\r\n          setGameData(data);\r\n        } else {\r\n          setError(`Game with ID ${gameId} not found.`);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Error fetching game details:\", err);\r\n        setError('Failed to load game details. Please try again later.');\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n    fetchGameData();\r\n  }, [gameId]);\r\n\r\n  if (loading) {\r\n    return <div className=\"game-review-page loading\">Loading game review...</div>;\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"game-review-page error\">\r\n        <h2>Error</h2>\r\n        <p>{error}</p>\r\n        <button onClick={() => navigate('/leaderboard')} className=\"button button-secondary\">\r\n          Back to Leaderboard\r\n        </button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!gameData) {\r\n    // This case should ideally be covered by the error state if not found\r\n    return <div className=\"game-review-page\">Game data could not be loaded.</div>;\r\n  }\r\n\r\n  // Ensure we only show classic mode details if applicable\r\n  const isClassicReview = gameData.mode === 'classic' && gameData.correctlySortedList && gameData.incorrectCountry;\r\n  const categoryDisplay = gameData.category === 'gini' ? 'Gini Index' : capitalize(gameData.category || 'Unknown');\r\n\r\n  return (\r\n    <div className=\"game-review-page\">\r\n      <h2>Game Review - {capitalize(gameData.mode || 'Game')} ({categoryDisplay})</h2>\r\n      <p>Score: {gameData.score}</p>\r\n      <p>Played on: {gameData.timestamp ? formatDate(gameData.timestamp) : 'Date unknown'}</p>\r\n\r\n      {isClassicReview ? (\r\n        <div className=\"review-section final-order-display\">\r\n          <h3>Your Final Correct Sequence & Mistake:</h3>\r\n          <div className=\"country-list combined-list\">\r\n            {gameData.correctlySortedList.map((country) => (\r\n              <CountryCard\r\n                key={`correct-${country.id || country.name}`}\r\n                country={country}\r\n                isClickable={false}\r\n                highlight={'correct'}\r\n                mode={gameData.category}\r\n                statisticValue={country.value}\r\n                isFlippable={true}\r\n              />\r\n            ))}\r\n\r\n            {gameData.incorrectCountry && (\r\n              <CountryCard\r\n                key={`incorrect-${gameData.incorrectCountry.id || gameData.incorrectCountry.name}`}\r\n                country={gameData.incorrectCountry}\r\n                isClickable={false}\r\n                highlight={'incorrect'}\r\n                mode={gameData.category}\r\n                statisticValue={gameData.incorrectCountry.value}\r\n                isFlippable={true}\r\n              />\r\n            )}\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"general-game-info review-section\">\r\n          <h3>Game Summary</h3>\r\n          {gameData.userAttemptList && gameData.userAttemptList.length > 0 ? (\r\n            <div className=\"country-list\">\r\n              {gameData.userAttemptList.map(item => (\r\n                <CountryCard\r\n                  key={`attempt-${item.id || item.name}`}\r\n                  country={item}\r\n                  isClickable={false}\r\n                  mode={gameData.category}\r\n                  statisticValue={item.value}\r\n                  isFlippable={true}\r\n                />\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <p>Basic game data is available, but detailed review for this mode might not be fully implemented.</p>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"navigation-buttons\" style={{ marginTop: '30px' }}>\r\n        <button onClick={() => navigate('/leaderboard')} className=\"button button-secondary\">\r\n          Back to Leaderboard\r\n        </button>\r\n        <Link to=\"/\" className=\"button button-secondary\">Go Home</Link>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default GameReviewPage; ","// src/App.js\n\nimport React, { useEffect } from 'react';\n// Import useMatch for extracting route params outside Routes\nimport { useLocation, Routes, Route, useMatch } from 'react-router-dom';\nimport { HelmetProvider } from 'react-helmet-async';\nimport ReactGA from 'react-ga4';\nimport Header from './components/Header';\nimport Footer from './components/Footer';\nimport HomePage from './pages/HomePage';\nimport UnifiedGamePage from './pages/GamePage';\nimport GameOverPage from './pages/GameOverPage';\nimport LeaderboardPage from './pages/LeaderboardPage';\nimport ProfilePage from './pages/ProfilePage';\nimport GameLobby from './components/GameLobby';\nimport { AuthProvider } from './contexts/AuthContext';\nimport { FirebaseTest } from './components/FirebaseTest';\nimport GameReviewPage from './pages/GameReviewPage';\nimport './App.css';\n\nfunction App() {\n  const location = useLocation();\n\n  // Check if the current path matches a game route pattern\n  const gameRouteMatch = useMatch('/game/:category/:mode');\n  const lobbyRouteMatch = useMatch('/game/:category/:mode/*'); // Match lobby routes too\n\n  // Extract category if we are on a game or lobby page\n  const gameCategory = gameRouteMatch?.params?.category || lobbyRouteMatch?.params?.category;\n\n  // Determine background class based on category\n  let backgroundClass = '';\n  if (gameCategory === 'population') {\n    backgroundClass = 'bg-population';\n  } else if (gameCategory === 'area') {\n    backgroundClass = 'bg-area';\n  } else if (gameCategory === 'gini') {\n    backgroundClass = 'bg-gini';\n  }\n\n  // Initialize Google Analytics only once\n  useEffect(() => {\n    ReactGA.initialize('G-9679TPXEBR'); // Replace with your Measurement ID\n  }, []);\n\n  // Send pageview whenever the pathname changes\n  useEffect(() => {\n    ReactGA.send({ hitType: 'pageview', page: location.pathname });\n  }, [location.pathname]);\n\n  return (\n    <HelmetProvider>\n      <AuthProvider>\n        {/* Apply dynamic background class */}\n        <div className={`App ${backgroundClass}`}>\n          <Header />\n          <div className=\"content\">\n            <Routes>\n              <Route path=\"/\" element={<HomePage />} />\n              {/* Updated lobby route path to match useMatch */}\n              <Route path=\"/game/:category/cooperation\" element={<GameLobby gameMode=\"cooperation\" />} />\n              <Route path=\"/game/:category/battleroyale\" element={<GameLobby gameMode=\"battleRoyale\" />} />\n              <Route path=\"/game/:category/:mode\" element={<UnifiedGamePage />} />\n              <Route path=\"/gameover\" element={<GameOverPage />} />\n              <Route path=\"/leaderboard\" element={<LeaderboardPage />} />\n              <Route path=\"/profile\" element={<ProfilePage />} />\n              <Route path=\"/test\" element={<FirebaseTest />} />\n              <Route path=\"/game-review/:gameId\" element={<GameReviewPage />} />\n            </Routes>\n          </div>\n          <Footer />\n        </div>\n      </AuthProvider>\n    </HelmetProvider >\n  );\n}\n\nexport default App;\n","// src/index.js\n\nimport React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport { HashRouter } from 'react-router-dom';\nimport { DndProvider } from 'react-dnd';\nimport { HTML5Backend } from 'react-dnd-html5-backend';\nimport App from './App';\nimport './index.css';\n\nconst root = ReactDOM.createRoot(document.getElementById('root'));\n\n// Wrap everything inside HashRouter\nroot.render(\n  <React.StrictMode>\n    <HashRouter>\n      <DndProvider backend={HTML5Backend}>\n        <App />\n      </DndProvider>\n    </HashRouter>\n  </React.StrictMode>\n);\n\n"],"sourceRoot":""}